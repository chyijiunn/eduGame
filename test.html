<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>ç´…å·¨æ˜Ÿæ•‘æ´è¨ˆç•«ï¼šSolar Rescue</title>
<style>
  html, body {
    margin: 0;
    height: 100%;
    background: #000;
    font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans TC", "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji";
    color: #fff;
  }
  #ui {
    position: fixed;
    left: 0; right: 0; top: 0;
    display: flex;
    gap: 10px;
    padding: 8px 12px;
    align-items: center;
    background: linear-gradient(180deg, rgba(0,0,0,.7), rgba(0,0,0,.25));
    backdrop-filter: blur(2px);
    z-index: 3;
    font-size: 14px;
  }
  #ui .pill { padding: 4px 8px; border-radius: 999px; background: rgba(255,255,255,.08); }
  #buttons { margin-left: auto; display: flex; gap: 8px; }
  button {
    background: rgba(255,255,255,.12);
    color: #fff; border: 0; border-radius: 8px;
    padding: 6px 10px; font-size: 14px;
  }
  button:hover { background: rgba(255,255,255,.18); cursor: pointer; }
  #msg {
    position: fixed; left: 50%; top: 60px; transform: translateX(-50%);
    padding: 8px 12px; border-radius: 8px; background: rgba(0,0,0,.6); z-index: 3;
    pointer-events: none; opacity: 0; transition: opacity .2s ease;
    white-space: pre-line;
  }
  #overlay {
    position: fixed; inset: 0; z-index: 4; display: none; place-items: center;
    background: rgba(0,0,0,.6);
  }
  #overlay .panel {
    max-width: min(720px, 92vw);
    background: rgba(15,15,20,.95);
    border: 1px solid rgba(255,255,255,.1);
    border-radius: 16px; padding: 18px 18px 14px;
    box-shadow: 0 10px 30px rgba(0,0,0,.5);
  }
  #overlay h2 { margin: 0 0 8px; }
  #overlay p, #overlay li { line-height: 1.5; color: #ddd; }
  #sunbar {
    position: fixed; left: 0; right: 0; bottom: 0;
    height: 8px; z-index: 2; background: rgba(255,255,255,.08);
  }
  #sunfill { height: 100%; width: 0; background: linear-gradient(90deg, #ffcf33, #ff3b3b); }
  canvas { display: block; width: 100vw; height: 100vh; }
  /* å°æç¤ºè§’æ¨™ */
  #hint {
    position: fixed; right: 12px; bottom: 16px; z-index: 3;
    background: rgba(0,0,0,.45); padding: 6px 10px; border-radius: 8px; font-size: 12px;
    opacity: .9;
  }
</style>
</head>
<body>
<div id="ui">
  <div class="pill">é—œå¡ï¼š<span id="levelName">â€”</span></div>
  <div class="pill">å‰©é¤˜ç”Ÿç‰©ï¼š<span id="leftCount">â€”</span></div>
  <div class="pill">å·²æ•‘æ´ ğŸ§ï¼š<span id="rescued">0</span></div>
  <div class="pill">æ­»äº¡ ğŸ’€ï¼š<span id="dead">0</span></div>
  <div id="buttons">
    <button id="helpBtn">èªªæ˜</button>
    <button id="retryBtn">é‡ç©é—œå¡</button>
    <button id="nextBtn" disabled>ä¸‹ä¸€é—œ â–¶</button>
  </div>
</div>
<div id="msg"></div>
<div id="overlay">
  <div class="panel">
    <h2>ç©æ³•èªªæ˜</h2>
    <ul>
      <li>å¤ªé™½å°‡çˆ†æˆç´…å·¨æ˜Ÿï¼Œä½ æ˜¯æ•‘æ´éšŠï¼Œè¦ä¾åºåœ¨å…«å¤§è¡Œæ˜Ÿä¸Šæ‹¯æ•‘å°ç”Ÿç‰©ã€‚</li>
      <li><b>ç¬¬ä¸€ä¸‹è§¸æ§/é»æ“Šæ˜¯éŒ¨é»</b>ï¼Œ<b>æ‹–æ›³è·é›¢=åŠ›é“</b>ï¼Œ<b>æ”¾é–‹=ç™¼å°„å¤ªç©ºæ¢­</b>ã€‚</li>
      <li>å¤ªç©ºæ¢­å—è¡Œæ˜Ÿé‡åŠ›å½±éŸ¿ã€‚è‹¥å¾<b>åˆ‡ç·šæ–¹å‘</b>é€²å…¥å¯<b>å½¢æˆç’°ç¹è»Œé“</b>ã€‚</li>
      <li>åœ¨<b>ç©©å®šç¹è¡Œ</b>ç‹€æ…‹ä¸‹ç¶“éä¸­å¤®ç”Ÿç‰©å³å¯<b>å®‰å…¨æ”¶å®¹</b>ï¼›éç¹è¡Œç‹€æ…‹ç¡¬æ’æœƒé€ æˆ<b>æ­»äº¡</b>ã€‚</li>
      <li>æœ¬é—œæ‰€æœ‰ç”Ÿç‰©è¢«æ•‘èµ°å°±èƒ½å‰é€²ä¸‹ä¸€é—œï¼›è‹¥å…¨æ»…å‰‡<b>éŠæˆ²çµæŸ</b>ï¼ˆå¯é‡è©¦ï¼‰ã€‚</li>
    </ul>
    <p style="opacity:.8">æç¤ºï¼šæ‹–æ›³æ–¹å‘å°±æ˜¯åˆé€Ÿæ–¹å‘ï¼›é è¿‘åˆ‡ç·šã€é€Ÿåº¦é©ä¸­è¼ƒæ˜“å…¥è»Œã€‚</p>
    <div style="margin-top:10px;display:flex;gap:8px;justify-content:flex-end">
      <button id="closeHelp">é–‹å§‹æ•‘æ´ ğŸš€</button>
    </div>
  </div>
</div>
<div id="sunbar"><div id="sunfill"></div></div>
<canvas id="game"></canvas>
<div id="hint">ç¬¬ä¸€ä¸‹ç‚ºéŒ¨é» â†’ æ‹–æ›³ â†’ æ”¾é–‹ç™¼å°„</div>

<script>
/* ========= è³‡æ–™å®šç¾© ========= */
const PLANETS = [
  // name, grav(m/s^2), visualRadius(px base), color, creatures, ring?
  {name:"æ°´æ˜Ÿ", g:3.7,  r:90,  color:"#7a8aa0", creatures:5},
  {name:"é‡‘æ˜Ÿ", g:8.87, r:120, color:"#d8b45b", creatures:6},
  {name:"åœ°çƒ", g:9.81, r:130, color:"#5fb9e5", creatures:7},
  {name:"ç«æ˜Ÿ", g:3.71, r:110, color:"#b3533a", creatures:7},
  {name:"æœ¨æ˜Ÿ", g:24.79,r:180, color:"#d89a6a", creatures:10},
  {name:"åœŸæ˜Ÿ", g:10.44,r:165, color:"#cdbb89", creatures:9, ring:true},
  {name:"å¤©ç‹æ˜Ÿ",g:8.69, r:140, color:"#7fd0c4", creatures:8},
  {name:"æµ·ç‹æ˜Ÿ",g:11.15,r:145, color:"#355edb", creatures:8}
];
// è¦–è¦ºç¸®æ”¾ï¼šè¡Œæ˜Ÿå¼•åŠ› â†’ æ¨¡æ“¬å¸¸æ•¸ï¼ˆè¶Šå¤§é‡åŠ›è¶Šå¼·ï¼‰
const G_CONST = 1000; // èª¿æ•´å¼•åŠ›å¼·åº¦
const AIR_DRAG = 0.000; // é‡‘æ˜Ÿç­‰å¯åšç‰¹ä¾‹æ‹–æ›³
/* ========= ç•«å¸ƒåˆå§‹åŒ– ========= */
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d', { alpha: false });
function resize(){
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
}
window.addEventListener('resize', resize);
resize();

/* ========= UI å…ƒç´  ========= */
const levelName = document.getElementById('levelName');
const leftCount = document.getElementById('leftCount');
const rescuedEl = document.getElementById('rescued');
const deadEl = document.getElementById('dead');
const nextBtn = document.getElementById('nextBtn');
const retryBtn = document.getElementById('retryBtn');
const helpBtn = document.getElementById('helpBtn');
const overlay = document.getElementById('overlay');
const closeHelp = document.getElementById('closeHelp');
const sunfill = document.getElementById('sunfill');
const msgEl = document.getElementById('msg');

function showMsg(t, ms=1200){
  msgEl.textContent = t;
  msgEl.style.opacity = 1;
  clearTimeout(showMsg._t);
  showMsg._t = setTimeout(()=> msgEl.style.opacity = 0, ms);
}
helpBtn.onclick = ()=> overlay.style.display = 'grid';
closeHelp.onclick = ()=> overlay.style.display = 'none';

/* ========= éŠæˆ²ç‹€æ…‹ ========= */
let level = 0;
let rescuedTotal = 0;
let deadTotal = 0;

let planet = null;
let creatures = []; // ç”Ÿç‰©é™£åˆ—
let ship = null;    // å–®ä¸€é£›è¡Œå™¨
let trail = [];     // èˆªè·¡
let inOrbitTimer = 0;
let orbitStable = false;
let sunProgress = 0; // 0~1 ç´…å·¨æ˜Ÿé€²åº¦

// æ‹–æ›³æ‰‹å‹¢
let dragging = false;
let anchor = null;
let pointer = null;

// èƒŒæ™¯å¤ªé™½
function bgSunGradient(progress){
  // ç”±é»ƒç™½ â†’ æ©˜ç´…
  const r = Math.floor(255*(0.6+0.4*progress));
  const g = Math.floor(200*(1-progress));
  const b = Math.floor(60*(1-progress));
  return `radial-gradient(circle at 15% 20%, rgba(${r},${g},${b},0.45), rgba(0,0,0,0.9) 55%)`;
}

/* ========= å¯¦é«”ï¼šç”Ÿç‰©èˆ‡å¤ªç©ºæ¢­ ========= */
function spawnCreatures(n){
  creatures = [];
  for(let i=0;i<n;i++){
    // ç”Ÿç‰©åœ¨ã€Œè¡Œæ˜Ÿä¸­å¿ƒé™„è¿‘ã€çš„å°ç¯„åœè·³å‹•ï¼ˆè¦–è¦º=å‰ªå½±ï¼‰
    creatures.push({
      alive:true,
      // è®“ä»–å€‘åœ¨æ˜Ÿçƒä¸­å¿ƒé™„è¿‘åŠå¾‘çš„ 0.35R ä»¥å…§å¾®å‹•
      baseR: planet.r * 0.35 * (0.6 + Math.random()*0.8),
      angle: Math.random()*Math.PI*2,
      jitter: Math.random()*0.6 + 0.4, // å‹•å¹…
    });
  }
}

function spawnShip(pos){
  ship = {
    x: pos.x, y: pos.y,
    vx: 0, vy: 0,
    alive: true,
    carrying: false, // æ˜¯å¦è¼‰åˆ°ç”Ÿç‰©
    t: 0
  };
  trail = [];
  orbitStable = false; inOrbitTimer = 0;
}

function planetCenter(){
  return { x: canvas.width*0.5, y: canvas.height*0.55 };
}

/* ========= é—œå¡æ§åˆ¶ ========= */
function loadLevel(i){
  level = i;
  planet = structuredClone(PLANETS[level]);
  // é‡‘æ˜Ÿç©ºæ°£é˜»åŠ›ï¼ˆå°å¹…ï¼‰
  planet.drag = (planet.name==="é‡‘æ˜Ÿ") ? 0.0006 : 0.00015;
  // å¤©ç‹æ˜Ÿ/æµ·ç‹æ˜Ÿè®“ç©ºé–“æ›´ã€Œæ»‘ã€
  if (planet.name==="å¤©ç‹æ˜Ÿ" || planet.name==="æµ·ç‹æ˜Ÿ") planet.drag *= 0.6;

  levelName.textContent = `${level+1}/8 ${planet.name}`;
  spawnCreatures(planet.creatures);
  leftCount.textContent = creatures.filter(c=>c.alive).length;
  nextBtn.disabled = true;
  ship = null;
  trail = [];
  inOrbitTimer = 0; orbitStable = false;
  // æ›´æ–°å¤ªé™½é€²åº¦æ¢
  sunProgress = (level)/ (PLANETS.length);
  sunfill.style.width = `${Math.floor(100*sunProgress)}%`;
  document.body.style.background = bgSunGradient(sunProgress);
  showMsg(`ç¬¬ ${level+1} é—œï¼š${planet.name}`);
}

function winLevel(){
  nextBtn.disabled = false;
  showMsg(`âœ… æœ¬é—œå®Œæˆï¼å¯å‰å¾€ä¸‹ä¸€é—œ`);
}
function gameOver(){
  showMsg(`âŒ ç”Ÿç‰©å…¨æ»…ï¼Œä»»å‹™å¤±æ•—ï¼ˆå¯é‡è©¦ï¼‰`, 1600);
}

/* ========= è¼¸å…¥äº‹ä»¶ï¼ˆæ»‘é¼  + è§¸æ§ï¼‰ ========= */
function getPointFromEvent(e){
  if (e.touches && e.touches.length) {
    return { x: e.touches[0].clientX, y: e.touches[0].clientY };
  }
  return { x: e.clientX, y: e.clientY };
}

canvas.addEventListener('pointerdown', e=>{
  dragging = true;
  anchor = getPointFromEvent(e);
  pointer = anchor;
});
canvas.addEventListener('pointermove', e=>{
  if (!dragging) return;
  pointer = getPointFromEvent(e);
});
window.addEventListener('pointerup', e=>{
  if (!dragging) return;
  dragging = false;
  // ç™¼å°„ï¼šèµ·é»=éŒ¨é»ï¼Œé€Ÿåº¦=éŒ¨é»â†’æ”¾é–‹å‘é‡ * æ¯”ä¾‹
  const release = getPointFromEvent(e);
  const dx = release.x - anchor.x;
  const dy = release.y - anchor.y;
  const speedScale = 0.035; // èª¿æ•´æ‰‹æ„Ÿï¼ˆè¶Šå¤§è¶Šå¿«ï¼‰
  spawnShip(anchor);
  ship.vx = dx * speedScale;
  ship.vy = dy * speedScale;
});

/* ========= ç‰©ç†æ›´æ–° ========= */
function step(dt){
  const c = planetCenter();

  // ç”Ÿç‰©æŠ–å‹•
  const t = performance.now()/1000;
  for(const b of creatures){
    if(!b.alive) continue;
    b.angle += 0.4*dt;
  }

  // é£›èˆ¹ç‰©ç†
  if (ship && ship.alive){
    ship.t += dt;
    const rx = c.x - ship.x;
    const ry = c.y - ship.y;
    const r2 = rx*rx + ry*ry;
    const r = Math.sqrt(r2);

    // ç¢°æ’åˆ¤å®šï¼ˆæ’åˆ°è¡Œæ˜Ÿè¡¨é¢ï¼‰
    if (r < planet.r*0.95){
      // ä¾é€Ÿåº¦è¦æ¨¡æ±ºå®šæ­»äº¡æ•¸
      const vmag = Math.hypot(ship.vx, ship.vy);
      const kill = Math.min(
        creatures.filter(b=>b.alive).length,
        Math.max(1, Math.floor(vmag/120)+ (planet.g>10?1:0))
      );
      // æ®ºæ­» kill éš»
      let leftToKill = kill;
      for (const b of creatures){
        if (b.alive && leftToKill>0){ b.alive=false; leftToKill--; }
      }
      deadTotal += kill;
      deadEl.textContent = deadTotal;
      leftCount.textContent = creatures.filter(b=>b.alive).length;
      showMsg(`ğŸ’¥ å¢œæ¯€ï¼æ­»äº¡ ${kill}`);
      ship.alive = false;
      checkLevelState();
      return;
    }

    // å¼•åŠ›ï¼ˆç°¡åŒ–è¬æœ‰å¼•åŠ›ï¼‰
    // a = G * gPlanet / r^2 æ–¹å‘æŒ‡å‘ä¸­å¿ƒï¼ˆé€™è£¡æŠŠè¡Œæ˜Ÿ g ç•¶ä½œè³ªé‡å°ºåº¦ï¼‰
    const g = (G_CONST * planet.g) / (r2 + 2000); // é˜²æ­¢ r=0 çˆ†ç‚¸
    const ax = g * (rx / r);
    const ay = g * (ry / r);

    // é˜»åŠ›ï¼ˆç°¡å–®é€Ÿåº¦æˆæ¯”ä¾‹ï¼‰
    const dvx = ship.vx * planet.drag;
    const dvy = ship.vy * planet.drag;

    ship.vx += (ax - dvx) * dt;
    ship.vy += (ay - dvy) * dt;

    ship.x += ship.vx * dt;
    ship.y += ship.vy * dt;

    // èˆªè·¡
    trail.push({x:ship.x, y:ship.y});
    if (trail.length>180) trail.shift();

    // è»Œé“ç©©å®šæ€§æª¢æ¸¬ï¼šè¿‘åˆ‡ç·š & åŠå¾‘è®ŠåŒ–å° ä¸€æ®µæ™‚é–“
    // æ¢ä»¶1ï¼šé€Ÿåº¦æ–¹å‘èˆ‡åŠå¾‘å‘é‡å¤¾è§’ ~90Â°ï¼ˆé»ç©æ¥è¿‘0ï¼‰
    const vmag = Math.hypot(ship.vx, ship.vy);
    const dot = (ship.vx * rx + ship.vy * ry) / (vmag * r + 1e-6);
    const nearTangent = Math.abs(dot) < 0.17; // å¤¾è§’ ~80~100 åº¦
    // æ¢ä»¶2ï¼šåŠå¾‘æ¥è¿‘æŸå®šå€¼ï¼ˆåœ¨åˆç†è»Œé“é«˜åº¦ï¼‰
    const nearRing = r > planet.r*1.02 && r < planet.r*1.8;

    if (nearTangent && nearRing) {
      inOrbitTimer += dt;
      if (inOrbitTimer > 1.2) orbitStable = true;
    } else {
      inOrbitTimer = Math.max(0, inOrbitTimer - dt*0.8);
      if (inOrbitTimer < 0.3) orbitStable = false;
    }

    // æº–å‚™æ•‘æ´ï¼šåªæœ‰åœ¨ç©©å®šç¹è¡Œæ™‚ï¼Œé£›è¶Šä¸­å¿ƒé™„è¿‘æ‰ç®—æˆåŠŸæ”¶å®¹
    if (orbitStable && !ship.carrying){
      // æª¢æŸ¥æœ€è¿‘çš„ä¸€éš»æ´»è‘—çš„ç”Ÿç‰©ï¼šå®ƒå€‘éƒ½åœ¨ä¸­å¿ƒé™„è¿‘åŠå¾‘~0.35R ç¯„åœ
      // ç”¨ã€Œç¶“éä¸­å¿ƒåŠå¾‘ 0.45Rã€è¦–ä½œèƒ½å®‰å…¨äº¤æœƒ
      if (r < planet.r*0.45){
        // æ”¶èµ°ä¸€éš»
        const target = creatures.find(b=>b.alive);
        if (target){
          target.alive = false;
          ship.carrying = true;
          rescuedTotal += 1;
          rescuedEl.textContent = rescuedTotal;
          leftCount.textContent = creatures.filter(b=>b.alive).length;
          showMsg(`ğŸ§ æ•‘åˆ° 1 éš»ï¼`);
        }
      }
    }

    // è¼‰åˆ°ç”Ÿç‰©å¾Œè‡ªå‹•ã€Œè¿”å›ã€ï¼šæ²¿åŠå¾‘å¤–é€ƒ
    if (ship.carrying){
      // çµ¦ä¸€å€‹æœå¤–çš„æ¨é€²ï¼ˆä¸€æ¬¡æ€§ï¼‰
      const nx = (ship.x - c.x)/ (r+1e-6);
      const ny = (ship.y - c.y)/ (r+1e-6);
      ship.vx += nx * 8*planet.drag; // å°æ¨åŠ›
      ship.vy += ny * 8*planet.drag;
      // æŠµé”ç•«é¢å¤–ç®—å®Œæˆé€™æ¬¡å‡ºæ“Š
      if (ship.x < -80 || ship.x > canvas.width+80 || ship.y < -80 || ship.y > canvas.height+80){
        ship.alive = false;
        checkLevelState();
      }
    }

    // é£›å‡ºå¾ˆé å°±ç•¶ä½œå¤±æ•—ï¼ˆè¶…å‡ºä»»å‹™å€åŸŸï¼‰
    if (!ship.carrying && (ship.x < -200 || ship.x > canvas.width+200 || ship.y < -200 || ship.y > canvas.height+200)){
      ship.alive = false;
      showMsg(`â åèˆªï¼Œè«‹å†è©¦ä¸€æ¬¡`);
      checkLevelState();
    }
  }
}

function checkLevelState(){
  const alive = creatures.filter(b=>b.alive).length;
  if (alive === 0){
    // è‹¥è©²é—œè‡³å°‘æ•‘åˆ° 1 éš» â†’ éé—œï¼›å¦å‰‡ Game Over
    // åˆ¤æ–·é€™é—œæ•‘æ´æ•¸ï¼šçœ‹æœ¬é—œç¸½æ•¸ - æ­»äº¡æ–¼æœ¬é—œ - å‰©é¤˜(=0)
    // ä½†ç°¡åŒ–ï¼šè‹¥å‰›å‰›æœ‰ä»»ä½• rescue äº‹ä»¶ï¼ŒrescuedTotal åœ¨æœ¬é—œä¸­è‡³å°‘ +1
    if (currentLevelRescued() > 0){
      winLevel();
    } else {
      gameOver();
    }
  }
}

function currentLevelRescued(){
  // ä¼°ç®—ï¼šå…¨åŸŸ rescuedTotal æ¸›å»ä¹‹å‰é—œå¡çš„ç´¯è¨ˆ
  // ç‚ºäº†ç°¡å–®ï¼Œé€²é—œæ™‚è¨˜éŒ„èµ·å§‹å€¼
  return rescuedTotal - (loadLevel._rescuedAtStart ?? 0);
}

/* ========= ç¹ªè£½ ========= */
function draw(){
  const w = canvas.width, h = canvas.height;
  const c = planetCenter();

  // èƒŒæ™¯æ˜Ÿç©ºèˆ‡å¤ªé™½æšˆ
  const grd = ctx.createRadialGradient(w*0.15, h*0.2, 30, w*0.15, h*0.2, Math.max(w,h)*0.9);
  const sunColor = `rgba(${200+Math.floor(55*sunProgress)}, ${150-Math.floor(90*sunProgress)}, ${40}, 0.5)`;
  grd.addColorStop(0, sunColor);
  grd.addColorStop(1, "#000000");
  ctx.fillStyle = grd;
  ctx.fillRect(0,0,w,h);

  // è¡Œæ˜Ÿæœ¬é«”
  // æ¼¸å±¤ + é‚Šç·£é™°å½±
  const pgr = ctx.createRadialGradient(c.x - planet.r*0.4, c.y - planet.r*0.4, planet.r*0.2, c.x, c.y, planet.r*1.2);
  pgr.addColorStop(0, lighten(planet.color, 0.25));
  pgr.addColorStop(0.7, planet.color);
  pgr.addColorStop(1, shade(planet.color, 0.65));
  ctx.fillStyle = pgr;
  ctx.beginPath();
  ctx.arc(c.x, c.y, planet.r, 0, Math.PI*2);
  ctx.fill();

  // åœŸæ˜Ÿå…‰ç’°
  if (planet.ring){
    ctx.save();
    ctx.translate(c.x, c.y);
    ctx.rotate(-0.35);
    ctx.strokeStyle = "rgba(230,210,160,0.65)";
    ctx.lineWidth = 12;
    ctx.beginPath();
    ctx.ellipse(0,0, planet.r*1.55, planet.r*0.75, 0, 0, Math.PI*2);
    ctx.stroke();
    ctx.lineWidth = 4;
    ctx.strokeStyle = "rgba(230,210,160,0.3)";
    ctx.beginPath();
    ctx.ellipse(0,0, planet.r*1.35, planet.r*0.66, 0, 0, Math.PI*2);
    ctx.stroke();
    ctx.restore();
  }

  // ç”Ÿç‰©ï¼ˆå‰ªå½±ï¼Œä¸­å¿ƒé™„è¿‘æŠ–å‹•ï¼‰
  for(const b of creatures){
    if(!b.alive) continue;
    const x = c.x + Math.cos(b.angle)*b.baseR*0.6;
    const y = c.y + Math.sin(b.angle*1.2)*b.baseR*0.4;
    drawCreature(x, y, 10);
  }

  // èˆªè·¡
  if (trail.length>1){
    ctx.strokeStyle = orbitStable ? "rgba(100,255,180,.9)" : "rgba(255,255,255,.6)";
    ctx.lineWidth = 2;
    ctx.beginPath();
    for (let i=0;i<trail.length;i++){
      const p = trail[i];
      if (i===0) ctx.moveTo(p.x, p.y);
      else ctx.lineTo(p.x, p.y);
    }
    ctx.stroke();
  }

  // é£›èˆ¹
  if (ship && ship.alive){
    drawShip(ship.x, ship.y, ship.vx, ship.vy, ship.carrying);
  }

  // æ‹–æ›³å‘é‡ï¼ˆç™¼å°„é è¦½ï¼‰
  if (dragging && anchor && pointer){
    ctx.strokeStyle = "rgba(255,255,255,.85)";
    ctx.fillStyle = "rgba(255,255,255,.15)";
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.moveTo(anchor.x, anchor.y);
    ctx.lineTo(pointer.x, pointer.y);
    ctx.stroke();
    ctx.beginPath();
    ctx.arc(anchor.x, anchor.y, 6, 0, Math.PI*2);
    ctx.fill();
  }

  // è¼”åŠ©ï¼šè»Œé“å¸¶ï¼ˆæç¤ºç¹è¡Œé«˜åº¦ï¼‰
  ctx.strokeStyle = "rgba(255,255,255,.08)";
  ctx.lineWidth = 1;
  ctx.beginPath();
  ctx.arc(c.x, c.y, planet.r*1.4, 0, Math.PI*2);
  ctx.stroke();
}

function drawCreature(x,y,s){
  // å°æ°´æ»´ + è§¸è§’çš„å‰ªå½±
  ctx.save();
  ctx.translate(x,y);
  ctx.fillStyle = "#000";
  ctx.shadowColor = "rgba(0,0,0,.3)";
  ctx.shadowBlur = 6;
  ctx.beginPath();
  ctx.moveTo(0,-s*0.9);
  ctx.quadraticCurveTo(s*0.9, -s*0.1, 0, s);
  ctx.quadraticCurveTo(-s*0.9, -s*0.1, 0, -s*0.9);
  ctx.fill();
  // å…©æ ¹å°è§’
  ctx.strokeStyle = "#000";
  ctx.lineWidth = 2;
  ctx.beginPath();
  ctx.moveTo(-s*0.2, -s*0.7);
  ctx.quadraticCurveTo(-s*0.6, -s*1.1, -s*0.4, -s*1.2);
  ctx.moveTo(s*0.2, -s*0.7);
  ctx.quadraticCurveTo(s*0.6, -s*1.1, s*0.4, -s*1.2);
  ctx.stroke();
  ctx.restore();
}

function drawShip(x,y,vx,vy, carrying){
  const ang = Math.atan2(vy, vx);
  ctx.save();
  ctx.translate(x,y);
  ctx.rotate(ang);
  // æ©Ÿèº«
  ctx.fillStyle = carrying ? "#7bffc9" : "#ffffff";
  ctx.beginPath();
  ctx.moveTo(14,0);
  ctx.lineTo(-10,-6);
  ctx.lineTo(-6,0);
  ctx.lineTo(-10,6);
  ctx.closePath();
  ctx.fill();
  // ç«ç„°
  ctx.fillStyle = carrying ? "rgba(100,255,200,.8)" : "rgba(255,160,80,.9)";
  ctx.beginPath();
  ctx.moveTo(-10,0);
  ctx.lineTo(-18,-3);
  ctx.lineTo(-16,0);
  ctx.lineTo(-18,3);
  ctx.closePath();
  ctx.fill();
  ctx.restore();
}

/* ========= é¡è‰²å·¥å…· ========= */
function hexToRgb(hex){
  const m = hex.replace('#','');
  const num = parseInt(m,16);
  if (m.length===6){
    return {r:(num>>16)&255, g:(num>>8)&255, b:num&255};
  }
  return {r:200,g:200,b:200};
}
function lighten(hex, k){
  const {r,g,b}=hexToRgb(hex); const L = c=>Math.min(255, Math.round(c + (255-c)*k));
  return `rgb(${L(r)},${L(g)},${L(b)})`;
}
function shade(hex, k){
  const {r,g,b}=hexToRgb(hex); const S = c=>Math.max(0, Math.round(c*(1-k)));
  return `rgb(${S(r)},${S(g)},${S(b)})`;
}

/* ========= ä¸»è¿´åœˆ ========= */
let last = performance.now();
function loop(now){
  const dt = Math.min(0.033, (now - last)/1000); // é™åˆ¶æœ€å¤§æ­¥é•·
  last = now;
  step(dt);
  draw();
  requestAnimationFrame(loop);
}

/* ========= æ§åˆ¶æŒ‰éˆ• ========= */
retryBtn.onclick = ()=>{
  loadLevel(level);
  loadLevel._rescuedAtStart = rescuedTotal;
};
nextBtn.onclick = ()=>{
  if (level < PLANETS.length-1){
    loadLevel(level+1);
    loadLevel._rescuedAtStart = rescuedTotal;
  } else {
    showMsg("ğŸ‰ å…¨éƒ¨é—œå¡å®Œæˆï¼ä½ å¸¶è‘—ä»–å€‘é›¢é–‹å¤ªé™½ç³»äº†");
  }
};

/* ========= åˆå§‹åŒ– ========= */
(function init(){
  loadLevel._rescuedAtStart = 0;
  loadLevel(0);
  overlay.style.display = 'grid'; // ç¬¬ä¸€æ¬¡é¡¯ç¤ºèªªæ˜
  requestAnimationFrame(loop);
})();
</script>
</body>
</html>