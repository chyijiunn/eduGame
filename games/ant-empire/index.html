<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>æ¨¡å¼èèŸ»è²»æ´›è’™ç­–ç•¥éŠæˆ² v0.6.2 â€” ref: åˆæˆè²»æ´›è’™ææ–™æ³•</title>
<style>
  :root { --bg:#0f1115; --panel:#151922; --ink:#e8eefc; --muted:#9aa4b2; --accent:#77e4a0; --danger:#ff7a7a; --warn:#ffd36e; }
  html,body{height:100%; margin:0; background:var(--bg); color:var(--ink); font-family: ui-sans-serif, system-ui, -apple-system, PingFangTC, "Noto Sans TC", Segoe UI, Roboto, Helvetica, Arial;}
  #wrap{display:grid; grid-template-columns: 1fr 380px; gap:10px; height:100vh; padding:10px; box-sizing:border-box;}
  #stage{position:relative; width:100%; height:100%;}
  #canvas{position:absolute; inset:0; background:#0b0d12; border:1px solid #22283a; border-radius:12px; width:100%; height:100%; display:block; image-rendering:pixelated}
  #panel{background:var(--panel); border-radius:14px; padding:12px; overflow:auto; display:grid; gap:10px}
  h2{margin:6px 0 8px; font-size:18px}
  .slot{background:#101625; border:1px solid #2b3246; border-radius:10px; padding:8px 10px; display:flex; align-items:center; gap:8px; justify-content:space-between}
  .col{display:flex; flex-direction:column; gap:8px; width:100%}
  .row{display:flex; gap:6px; align-items:center; flex-wrap:wrap}
  button,select,input[type="range"]{background:#23293a; color:var(--ink); border:1px solid #2b3246; border-radius:10px; padding:6px 10px; cursor:pointer}
  input[type="range"]{padding:4px 6px; width:220px}
  button:hover{filter:brightness(1.08)}
  .pill{border:1px solid #334; border-radius:30px; padding:4px 8px; font-size:12px}
  .badge{font-size:11px; padding:2px 6px; border-radius:8px; background:#223}
  .mini{font-size:12px; color:var(--muted)}
  #errorOverlay{position:fixed; right:12px; bottom:12px; display:none; z-index:9999; background:#1d2233; color:#ffd1d1; border:1px solid #b44; border-radius:12px; padding:12px; box-shadow:0 6px 30px #0008; max-width:40vw}
  #errorOverlay pre{white-space:pre-wrap; font-family:ui-monospace, SFMono-Regular, Menlo, monospace; font-size:12px; color:#ffd1d1}
  #refModal{position:fixed; inset:0; display:none; place-items:center; background:#0008}
  #refCard{width:min(1040px,94vw); height:min(84vh,760px); background:#111522; border:1px solid #2b3246; border-radius:14px; overflow:auto; padding:16px}
  table{width:100%; border-collapse:collapse; font-size:13px}
  th,td{border-bottom:1px solid #2b3246; padding:6px 8px; text-align:left; vertical-align:top}
  #wxBox{display:flex; align-items:center; gap:8px}
  #wxArrow{width:160px; height:42px; background:#0c1020; border:1px solid #2b3246; border-radius:8px}
  .tabbar{display:flex; gap:8px; margin:8px 0 12px}
  .tabbar button{background:#1a1f2f; border-color:#2b3246}
  .tabbar button.active{background:#26304a}
  .note{color:#9aa4b2; font-size:12px}
  .kbd{border:1px solid #2b3246; border-bottom-width:2px; background:#0f1423; border-radius:6px; padding:0 6px; font-family:ui-monospace,Consolas,monospace; font-size:12px}
</style>
</head>
<body>
  <div id="wrap">
    <div id="stage">
      <canvas id="canvas"></canvas>
    </div>
    <div id="panel">
      <div class="slot"><b>é—œå¡</b>
        <span class="row">
          <select id="levelSel">
            <option value="1">Lv1</option>
            <option value="2">Lv2</option>
            <option value="3">Lv3</option>
            <option value="4">Lv4</option>
          </select>
          <button id="btnRestart">é‡æ–°é–‹å§‹</button>
          <button id="btnRef">ref</button>
        </span>
      </div>
      <div class="slot">
        <span>ğŸ¯ <span id="goalText"></span></span>
        <span id="timerWrap" style="display:none">â± <span id="timerText">0</span>s</span>
      </div>
      <div class="slot col">
        <div class="row" style="justify-content:space-between">
          <b>é€Ÿåº¦</b><span class="mini" id="speedLabel">1Ã—</span>
        </div>
        <input type="range" id="speedRange" min="1" max="100" step="1" value="1">
      </div>
      <div class="slot col">
        <b>è¦–åœ–</b>
        <div class="row">
          <button id="btnZoomIn">ï¼‹</button>
          <button id="btnZoomOut">ï¼</button>
          <button id="btnZoomReset">1:1</button>
        </div>
      </div>
      <div class="slot col">
        <b>çµ±è¨ˆ</b>
        <table id="statsTable">
          <thead><tr><th>é™£ç‡Ÿ</th><th>èèŸ»æ•¸</th><th>æ¬é‹ä¸­</th><th>å¾—åˆ†</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="slot col">
        <b>åœ°åœ–é£Ÿç‰©</b>
        <table id="foodTable">
          <thead><tr><th>ç¨®é¡</th><th>æ•¸é‡</th><th>å‰©é¤˜ç¸½é‡</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="slot"><b>ç“¶åº«</b><div id="invList" class="row"></div></div>
      <div class="slot"><b>åˆæˆ</b><span class="row"><select id="craftSel"></select><button id="btnCraft">+1</button></span></div>
      <div class="slot col">
        <b>ææ–™</b>
        <div id="matRow" class="row"></div>
      </div>
      <div class="slot">
        <b>å¤©æ°£</b>
        <div id="wxBox">
          <canvas id="wxArrow" width="160" height="42"></canvas>
          <div class="mini" id="wxText">â€”</div>
        </div>
      </div>
      <div id="nextActions" class="slot" style="display:none; justify-content:flex-start; gap:8px">
        <b id="nextLabel"></b>
        <button id="btnNext" style="display:none"></button>
        <button id="btnAddEnemy" style="display:none">æ–°å¢æ•µäºº</button>
      </div>
    </div>
  </div>

  <div id="refModal"><div id="refCard"></div></div>
  <div id="errorOverlay"><b>âš ï¸ è…³æœ¬éŒ¯èª¤</b><pre id="errorText"></pre></div>

<script>
'use strict';
/*********** å°å·¥å…· ***********/
CanvasRenderingContext2D.prototype._rr = function(x,y,w,h,r){
  if(this.roundRect){ this.roundRect(x,y,w,h,r); return; }
  r = Math.min(r, w/2, h/2);
  this.beginPath();
  this.moveTo(x+r, y);
  this.arcTo(x+w, y, x+w, y+h, r);
  this.arcTo(x+w, y+h, x, y+h, r);
  this.arcTo(x, y+h, x, y, r);
  this.arcTo(x, y, x+w, y, r);
  this.closePath();
};
function rr(o,x,y,w,h,r){ o._rr(x,y,w,h,r); o.fill(); o.stroke(); }
function drawArrow(o,x,y,len,ang,color){ o.save(); o.translate(x,y); o.rotate(ang); o.strokeStyle=color; o.lineWidth=2; o.beginPath(); o.moveTo(0,0); o.lineTo(len,0); o.stroke(); o.beginPath(); o.moveTo(len,0); o.lineTo(len-6, 3); o.lineTo(len-6, -3); o.closePath(); o.fillStyle=color; o.fill(); o.restore(); }

/******************** ref ********************/
const REF=[
  {id:'m4mp2c',short:'å¡å’¯é…¸ç”²é…¯',formal:'methyl 4-methylpyrrole-2-carboxylate',cls:'è·¯å¾‘-çŸ­',source:'æ¯’è…º'},
  {id:'edp',short:'ä¹™åŸºäºŒç”²åŸºå¡å—ªï¼ˆEDPï¼‰',formal:'3-ethyl-2,5-dimethylpyrazine',cls:'è·¯å¾‘/è­¦æˆ’',source:'æ¯’è…º'},
  {id:'faranal',short:'Faranal',formal:'faranal',cls:'è·¯å¾‘-é•·',source:'æœä½›æ°è…º'},
  {id:'mono1',short:'Monomorine I',formal:'monomorine I',cls:'æ‹›å‹Ÿ-çŸ­',source:'æ¯’è…º'},
  {id:'noentry',short:'ç¦æ­¢æ··åˆç‰©',formal:'no-entry blend',cls:'ç¦æ­¢',source:'æ¯’è…º'},
  {id:'formic',short:'èŸ»é…¸',formal:'formic acid',cls:'é˜²ç¦¦',source:'æ¯’è…º'},
  {id:'c11',short:'åä¸€çƒ·',formal:'n-undecane',cls:'å¢æ•ˆ',source:'æœä½›æ°è…º/æ¯’è…º'},
  {id:'farnesene',short:'Î±-æ³•å‘¢çƒ¯',formal:'(Z,E)-Î±-farnesene',cls:'æ‹›å‹Ÿ',source:'æœä½›æ°è…º'},
  {id:'dolich',short:'å¤šåˆ©å…‹äºŒé†›',formal:'dolichodial',cls:'è·¯å¾‘',source:'è…¹ç«¯è…º'},
  {id:'irido',short:'Iridomyrmecin',formal:'iridomyrmecin',cls:'è·¯å¾‘',source:'è…¹ç«¯è…º'},
  {id:'z9',short:'Z9-16 é†›',formal:'(Z)-9-hexadecenal',cls:'å¢ç›Š',source:'è…¹ç«¯è…º'}
];
const MATERIALS=['C','O','N','R','T','Ald','Acid','HC','LAC'];
const RECIPES={m4mp2c:{label:'å¡å’¯é…¸ç”²é…¯',cost:{C:1,O:1,N:1}}, edp:{label:'ä¹™åŸºäºŒç”²åŸºå¡å—ª',cost:{N:2,R:1,C:1}}, faranal:{label:'Faranal',cost:{T:2,Ald:1,HC:1}}, mono1:{label:'Monomorine I',cost:{N:1,R:1,HC:1}}, noentry:{label:'ç¦æ­¢æ··åˆç‰©',cost:{Ald:1,Acid:1,HC:1}}, formic:{label:'èŸ»é…¸',cost:{Acid:2}}, c11:{label:'åä¸€çƒ·',cost:{HC:2}}, farnesene:{label:'Î±-æ³•å‘¢çƒ¯',cost:{T:2,HC:1}}, dolich:{label:'å¤šåˆ©å…‹äºŒé†›',cost:{Ald:2,R:1}}, irido:{label:'Iridomyrmecin',cost:{LAC:1,T:1}}, z9:{label:'Z9-16 é†›',cost:{Ald:1,HC:1}}};

/******************** åƒæ•¸ï¼ˆéŠæˆ²ï¼‰ ********************/
const TILE=16; let W=64, H=48; const WORLD_W=W*TILE, WORLD_H=H*TILE;
let level=1; let timeLeft=0; let showTimer=false;
let viewScale=1.0, viewX=0, viewY=0, timeScale=1.0;
const T_EMPTY=0, T_WATER=1, T_FOOD=2, T_NEST_ME=3, T_NEST_RIVAL=4, T_WALL=5, T_TARGET=7;
const PH={m4mp2c:{type:'trail',color:'#68f',strength:2,halfLife:20}, edp:{type:'trail',color:'#9bf',strength:2,halfLife:15}, faranal:{type:'trail',color:'#6fa',strength:3,halfLife:60}, mono1:{type:'recruit',color:'#aff',strength:2,halfLife:18}, noentry:{type:'ban',color:'#f77',strength:3,halfLife:30}, formic:{type:'acid',color:'#f55',strength:2,halfLife:8}, c11:{type:'alkane',color:'#fc8',strength:0,halfLife:20}, farnesene:{type:'recruit',color:'#dff76a',strength:2,halfLife:25}, dolich:{type:'trail',color:'#a5f',strength:2,halfLife:25}, irido:{type:'trail',color:'#c7f',strength:2,halfLife:25}, z9:{type:'boost',color:'#fff38a',strength:0,halfLife:12}};

/******************** ç•«å¸ƒ ********************/
const canvas=document.getElementById('canvas'); const ctx=canvas.getContext('2d');
function resizeCanvas(){ const rect=canvas.getBoundingClientRect(); const dpr=window.devicePixelRatio||1; canvas.width=Math.max(1, Math.floor(rect.width*dpr)); canvas.height=Math.max(1, Math.floor(rect.height*dpr)); }
window.addEventListener('resize', function(){ resizeCanvas(); });

/******************** ç‹€æ…‹ ********************/
let grid=[], scoreMe=0, scoreRival=0; let ants=[], antsRival=[]; let carrying=0; let mats={}, inventory={}, unlocked=[], selectedPh=null;
let colonyCap=40, colonyMax=Infinity, spawnBudget=0, rivalSpawn=150;
let wx={wind:1.2, windDir:0, humidIdx:3, raining:false, tDir:0};
let targets=[]; let enemies=[];

/******************** å·¥å…· ********************/
function inBounds(x,y){ return x>=0&&y>=0&&x<W&&y<H; } function idx(x,y){ return y*W+x; } function randInt(a,b){ return Math.floor(Math.random()*(b-a+1))+a; } function choice(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }
function clone(obj){ return JSON.parse(JSON.stringify(obj)); }

/******************** é›¢å±ç²¾éˆï¼šèèŸ» / é£Ÿç‰© ********************/
const SCALE=8; const ANT_W=6, ANT_H=4; const FOOD_W=10, FOOD_H=8;
const frames={antsMe:[], antsRv:[], food:{}};
function mkAnt(phase,flip,stroke){ const off=document.createElement('canvas'), o=off.getContext('2d'); off.width=ANT_W*SCALE; off.height=ANT_H*SCALE; o.scale(SCALE,SCALE); o.lineWidth=0.9; o.strokeStyle=stroke; o.translate(ANT_W/2,ANT_H/2); if(flip) o.scale(-1,1); o.translate(-ANT_W/2,-ANT_H/2); o.beginPath(); o.ellipse(1.6,2,1.6,1.2,0,0,Math.PI*2); o.ellipse(3.4,2,1.2,1.0,0,0,Math.PI*2); o.ellipse(4.8,2,0.9,0.9,0,0,Math.PI*2); o.stroke(); const A=0.6; for(let i=0;i<3;i++){ const p=phase?1:-1, bx=[1.4,3.0,4.4][i], by=2; const a1=(i*0.6 + p*A), a2=(i*0.6 - p*A); o.beginPath(); o.moveTo(bx,by-0.4); o.lineTo(bx+Math.cos(a1)*1.5,by-0.4+Math.sin(a1)*1.5); o.stroke(); o.beginPath(); o.moveTo(bx,by+0.4); o.lineTo(bx+Math.cos(a2)*1.5,by+0.4+Math.sin(a2)*1.5); o.stroke(); } o.beginPath(); o.moveTo(5.3,1.3); o.lineTo(6,0.5); o.moveTo(5.3,2.7); o.lineTo(6,3.3); o.stroke(); return off; }
function mkFood(kind){ const off=document.createElement('canvas'), o=off.getContext('2d'); off.width=FOOD_W*SCALE; off.height=FOOD_H*SCALE; o.scale(SCALE,SCALE); o.lineWidth=1; o.strokeStyle="#ffffffaa";
  function sugar(){ o.fillStyle="#ffe9a6"; rr(o,0.8,1,FOOD_W-1.6,FOOD_H-2,1); }
  function peanut(){ o.fillStyle="#caa86d"; o.beginPath(); o.ellipse(FOOD_W/2,FOOD_H/2,4.0,2.4,0,0,Math.PI*2); o.fill(); o.stroke(); }
  function fish(){ o.fillStyle="#88b7ff"; o.beginPath(); o.ellipse(FOOD_W/2+0.5,FOOD_H/2,3.8,1.9,0,0,Math.PI*2); o.fill(); o.stroke(); o.beginPath(); o.moveTo(1.2,FOOD_H/2); o.lineTo(2.2,FOOD_H/2-1.4); o.lineTo(2.2,FOOD_H/2+1.4); o.closePath(); o.fill(); o.stroke(); }
  function resin(){ o.fillStyle="#f6c84a"; o.beginPath(); o.moveTo(FOOD_W/2,1); o.bezierCurveTo(FOOD_W-1,2.5,FOOD_W-1,4.8,FOOD_W/2,FOOD_H-1); o.bezierCurveTo(1,4.8,1,2.5,FOOD_W/2,1); o.fill(); o.stroke(); }
  function citrus(){ o.fillStyle="#ffa94d"; o.beginPath(); o.arc(FOOD_W/2,FOOD_H/2,3.4,Math.PI*0.1,Math.PI*0.9); o.lineTo(FOOD_W/2,FOOD_H/2); o.closePath(); o.fill(); o.stroke(); }
  function oil(){ o.fillStyle="#c7ffd1"; o.beginPath(); o.ellipse(FOOD_W/2,FOOD_H/2,3.4,2.2,0.3,0,Math.PI*2); o.fill(); o.stroke(); }
  function berry(){ o.fillStyle="#ff7aa8"; o.beginPath(); o.ellipse(FOOD_W/2-0.6,FOOD_H/2,2.0,2.0,0,0,Math.PI*2); o.fill(); o.stroke(); o.beginPath(); o.ellipse(FOOD_W/2+1.2,FOOD_H/2,2.0,2.0,0,0,Math.PI*2); o.fill(); o.stroke(); }
  function wax(){ o.fillStyle="#ffd36e"; rr(o,1.0,1.2,FOOD_W-2.0,FOOD_H-2.4,0.8); }
  function chitin(){ o.fillStyle="#b9d4ff"; o.beginPath(); o.moveTo(1.2,FOOD_H-1.2); o.lineTo(FOOD_W/2,1.2); o.lineTo(FOOD_W-1.2,FOOD_H-1.2); o.closePath(); o.fill(); o.stroke(); }
  ({sugar,peanut,fish,resin,citrus,oil,berry,wax,chitin}[kind]||sugar)(); return off; }
frames.antsMe.push(mkAnt(0,0,"#9ffcac"),mkAnt(1,0,"#9ffcac"),mkAnt(0,1,"#9ffcac"),mkAnt(1,1,"#9ffcac"));
frames.antsRv.push(mkAnt(0,0,"#cfd3da88"),mkAnt(1,0,"#cfd3da88"),mkAnt(0,1,"#cfd3da88"),mkAnt(1,1,"#cfd3da88"));
['sugar','peanut','fish','resin','citrus','oil','berry','wax','chitin'].forEach(k=>frames.food[k]=mkFood(k));

/******************** å¤©æ°£ï¼ˆæ‰¿ v0.6.1ï¼‰ ********************/
function rndSign(){ return Math.random()<0.5?-1:1; }
function stepWeather(dt){
  const mean=1.2, k=0.9;
  wx.wind = clamp(wx.wind + (mean - wx.wind)*k*dt + (Math.random()-0.5)*0.6*dt, 0, 4.0);
  wx.tDir += dt; if(wx.tDir>=30){ wx.windDir = (wx.windDir + (Math.random()*300 - 150)) % 360; wx.tDir=0; }
  if(Math.random()<0.02*dt){ wx.humidIdx = clamp(wx.humidIdx + rndSign()*1, 0, 6); }
  wx.raining = (wx.humidIdx===6 && wx.wind>3.2);
  const humidText=['æ¥µä¹¾','å¾ˆä¹¾','åä¹¾','ä¸­ç­‰','åæ¿•','å¾ˆæ¿•','æ¥µæ¿•'][wx.humidIdx];
  document.getElementById('wxText').textContent = 'é¢¨ ' + wx.wind.toFixed(1) + ' m/s @ ' + wx.windDir.toFixed(0) + 'Â°ï½œæ¿•åº¦ ' + humidText + (wx.raining?'ï½œğŸŒ§ ä¸‹é›¨':'');
  drawWxArrow();
}
function drawWxArrow(){
  const c=document.getElementById('wxArrow'); if(!c) return; const o=c.getContext('2d'); o.setTransform(1,0,0,1,0,0); o.clearRect(0,0,c.width,c.height);
  const cx=18, cy=c.height/2; const len = 24 + wx.wind*18; const ang = wx.windDir * Math.PI/180;
  o.strokeStyle="#283049"; o.beginPath(); o.moveTo(2,cy); o.lineTo(c.width-2,cy); o.stroke();
  drawArrow(o, cx, cy, len, ang, "#9aa4b2");
  o.fillStyle="#9aa4b2"; o.font="12px ui-sans-serif"; o.fillText(wx.wind.toFixed(1)+" m/s", cx+len+8, cy+4);
}

/******************** åœ°åœ–èˆ‡é—œå¡ï¼ˆåŒ v0.6.1ï¼‰ ********************/
function baseRandomMap(waterRatio){
  grid=new Array(W*H).fill(0).map(function(){return {type:T_EMPTY, food:null, pherMe:{}, pherRv:{}, sniff:0, owner:null, control:0};});
  for(let y=0;y<H;y++){ for(let x=0;x<W;x++){ if(Math.random()<waterRatio) grid[idx(x,y)].type=T_WATER; } }
  for(let i=0;i<Math.floor((W+H)/2); i++){ const side=Math.random()<0.5?0:W-1; const y=randInt(0,H-1); grid[idx(side,y)].type=T_WATER; }
}
function randomNest(){ return {x:randInt(2,W-3), y:randInt(2,H-3)}; }
function placeNestsRandom(){ const a=randomNest(); const b=randomNest(); grid[idx(a.x,a.y)].type=T_NEST_ME; grid[idx(b.x,b.y)].type=T_NEST_RIVAL; }
function placeNestsCorners(){ grid[idx(2,2)].type=T_NEST_ME; grid[idx(W-3,H-3)].type=T_NEST_RIVAL; }
function scatterFood(list,count){
  for(let i=0;i<count;i++){
    const x=randInt(2,W-3), y=randInt(2,H-3);
    if(grid[idx(x,y)].type===T_EMPTY){
      const item=Object.assign({}, choice(list));
      item.size = Math.round(1 + Math.random()*9);
      item.hp = Math.ceil(item.size*5);
      item.maxhp=item.hp;
      item.notchDir = Math.random()*Math.PI*2;
      grid[idx(x,y)].type=T_FOOD; grid[idx(x,y)].food=item;
    }
  }
}
function spawnTargets(n){
  targets=[];
  for(let i=0;i<n;i++){
    const x=randInt(4,W-5), y=randInt(4,H-5);
    if(grid[idx(x,y)].type===T_EMPTY){
      grid[idx(x,y)].type=T_TARGET; grid[idx(x,y)].owner=null; grid[idx(x,y)].control=0;
      targets.push({x,y});
    } else { i--; }
  }
}
function makeMap_Lv1(){
  baseRandomMap(0.08); placeNestsCorners();
  scatterFood([{type:'sugar',yield:{O:2,C:1}}, {type:'peanut',yield:{C:2,R:1}}, {type:'fish',yield:{N:2,C:1}}], 26);
  setGoal('Lv1ï¼šæ²’æœ‰æ™‚é–“é™åˆ¶ã€‚æ¬å›çš„é¡†ç²’æ•¸é‡è¦è¶…éå°æ‰‹ã€‚');
  showTimer=false; colonyCap=30; colonyMax=500; timeLeft=0;
}
function makeMap_Lv2(){
  baseRandomMap(0.08); placeNestsRandom();
  scatterFood([{type:'resin',yield:{T:2,C:1}},{type:'citrus',yield:{Ald:1,O:1,R:1}},{type:'oil',yield:{HC:2,C:1}}], 22);
  spawnTargets(4);
  setGoal('Lv2ï¼šåœ¨æ™‚é–“å…§ä½”é ˜çš„æ§åˆ¶é»æ•¸é‡è¦å¤šæ–¼æ•µæ–¹ã€‚');
  showTimer=true; timeLeft=160; colonyCap=60; colonyMax=Infinity;
}
function makeMap_Lv3(){
  baseRandomMap(0.06); placeNestsCorners();
  scatterFood([{type:'berry',yield:{Acid:2,O:1}}, {type:'wax',yield:{HC:2}}, {type:'chitin',yield:{N:1,Acid:1,R:1}}], 20);
  setGoal('Lv3ï¼šä¸­å‹æ•µäººå¯è¢«æ“Šæ•—è½‰ç‚ºé£Ÿç‰©ï¼›å¯æ–°å¢æ•µäººã€‚');
  showTimer=true; timeLeft=150; colonyCap=80; colonyMax=Infinity;
}
function makeMap_Lv4(){
  baseRandomMap(0.08); placeNestsCorners();
  scatterFood([{type:'resin',yield:{T:2,C:1}},{type:'citrus',yield:{Ald:1,O:1,R:1}},{type:'oil',yield:{HC:2,C:1}}], 20);
  setGoal('Lv4ï¼šå¸å¼•ï¼‹ç¦æ­¢å°å¼•è‡³æ­£ç¢ºé£Ÿç‰©ï¼ˆç¤ºæ„ï¼‰ã€‚');
  showTimer=true; timeLeft=160; colonyCap=60; colonyMax=Infinity;
}
function setGoal(t){ document.getElementById('goalText').textContent=t; document.getElementById('timerWrap').style.display = showTimer ? 'inline-flex' : 'none'; }

/******************** æ•µäººï¼ˆæ‰¿ v0.6.1 æ•¸å€¼ï¼‰ ********************/
let enemies=[]; function makeEnemy(kind){ const base = { kind, x:randInt(8,W-8)*TILE, y:randInt(8,H-8)*TILE, aim:Math.random()*Math.PI*2, hp:24, speed:24, alive:true, scale:1.6 }; if(kind==='gecko'){ base.hp=36; base.speed=22; base.scale=1.8; } if(kind==='roach'){ base.hp=28; base.speed=28; base.scale=1.5; } return base; }
function stepEnemies(dt){ for(let e of enemies){ if(!e.alive) continue; if(Math.random()<0.05) e.aim += (Math.random()-0.5)*0.8; const dx=Math.cos(e.aim)*e.speed*dt, dy=Math.sin(e.aim)*e.speed*dt; let nx=e.x+dx, ny=e.y+dy; const gx=Math.floor(nx/TILE), gy=Math.floor(ny/TILE); if(!inBounds(gx,gy) || grid[idx(gx,gy)].type===T_WATER){ e.aim += Math.PI*0.6; continue; } e.x=nx; e.y=ny; function combat(list){ for(const a of list){ const d=Math.hypot(a.x-e.x,a.y-e.y); if(d<12*e.scale){ e.hp -= 3*dt; if(Math.random()<0.12*dt){ a.hp -= 1; if(a.hp<=0){ a.alive=false; } } } } } combat(ants); combat(antsRival); if(e.hp<=0){ e.alive=false; const gx2=Math.floor(e.x/TILE), gy2=Math.floor(e.y/TILE); if(inBounds(gx2,gy2) && grid[idx(gx2,gy2)].type===T_EMPTY){ const sizeYield = Math.max(1, Math.round(3*e.scale)); grid[idx(gx2,gy2)].type=T_FOOD; grid[idx(gx2,gy2)].food={type:'fish',yield:{N:2*sizeYield,C:1}, size:3*e.scale, hp:6*sizeYield, maxhp:6*sizeYield, notchDir:Math.random()*Math.PI*2}; } showNextAction('æ•µäººè¢«æ“Šæ•—ï¼', null, true); } } ants = ants.filter(a=>a.alive!==false); antsRival = antsRival.filter(a=>a.alive!==false); }

/******************** èèŸ»&è²»æ´›è’™ï¼ˆæ‰¿ v0.6.1ï¼‰ ********************/
function findNest(team){ for(let y=0;y<H;y++){ for(let x=0;x<W;x++){ const t=grid[idx(x,y)].type; if(team==='me'&&t===T_NEST_ME) return {x:x,y:y}; if(team==='rv'&&t===T_NEST_RIVAL) return {x:x,y:y}; } } return {x:1,y:1}; }
function spawnAnt(team){ const n=findNest(team); const px=n.x*TILE+TILE/2, py=n.y*TILE+TILE/2; const aim=Math.random()*Math.PI*2; return {team:team, x:px, y:py, aim:aim, speed:26+Math.random()*10, sinceSig:0, sinceSteps:0, changeAt:(3+Math.random()*2)*ANT_H, carry:false, load:null, cool:0, hp:3, phCharge:4, phMax:6, dropCooldown:0, lastX:px, lastY:py, stuckT:0}; }
function signalMass(team){ let s=0; for(let i=0;i<grid.length;i++){ const p=team==='me'?grid[i].pherMe:grid[i].pherRv; if(!p) continue; for(const k in p){ const t=PH[k].type; if(t==='trail'||t==='recruit') s+=p[k]*PH[k].strength; } } return s; }
function desiredPopulation(){ const k=0.05; const want=Math.min(colonyMax, colonyCap + Math.floor(k*signalMass('me'))); return want; }
function selectedOrDefaultTrail(){ if(selectedPh && (PH[selectedPh].type==='trail' || PH[selectedPh].type==='recruit')) return selectedPh; return 'm4mp2c'; }
function placePher(x,y,key,amt,team){ if(amt===undefined) amt=1; if(!inBounds(x,y)) return; const c=grid[idx(x,y)]; if([T_WATER,T_WALL].includes(c.type)) return; const bucket=(team==='rv'?c.pherRv:c.pherMe); const windRad=(wx.windDir*Math.PI/180); const boost=1 + Math.max(0,Math.cos(windRad))*(wx.wind/3.5)*0.6; bucket[key]=(bucket[key]||0)+amt*boost; c.sniff=c.sniff||0; }
function localTrailStrength(gx,gy,team){ if(!inBounds(gx,gy)) return 0; const p=(team==='rv'?grid[idx(gx,gy)].pherRv:grid[idx(gx,gy)].pherMe)||{}; let s=0; for(const k in p){ const t=PH[k].type; if(t==='trail'||t==='recruit') s+=p[k]; } return s; }
function stepPher(dt){ for(let i=0;i<grid.length;i++){ const c=grid[i]; function decay(p){ for(const k in p){ const humidScale=[1.5,1.3,1.15,1.0,0.9,0.8,0.7][wx.humidIdx]; const hl=PH[k].halfLife*humidScale; const windDilute=1 + wx.wind*0.04; p[k]-=dt*(windDilute/hl); if(wx.raining) p[k]-=dt*0.6; if(p[k]<=0) delete p[k]; } } decay(c.pherMe); decay(c.pherRv); } }
function sniffAt(x,y){ if(!inBounds(x,y)) return; const c=grid[idx(x,y)]; c.sniff=(c.sniff||0)+1; if(c.sniff%30===0){ for(const k in c.pherMe){ c.pherMe[k]*=0.8; } for(const k in c.pherRv){ c.pherRv[k]*=0.8; } } }

/******************** éŠæˆ²æµç¨‹ ********************/
let nextReady=false;
function resetGame(){
  ants=[]; antsRival=[]; inventory={}; mats={}; scoreMe=0; scoreRival=0; carrying=0; unlocked=Object.keys(RECIPES); selectedPh='m4mp2c'; MATERIALS.forEach(k=>mats[k]=0);
  targets=[]; enemies=[]; nextReady=false; hideNextAction();
  if(level===1) makeMap_Lv1(); if(level===2) makeMap_Lv2(); if(level===3) makeMap_Lv3(); if(level===4) makeMap_Lv4();
  for(let i=0;i<10;i++) ants.push(spawnAnt('me'));
  for(let i=0;i<50;i++) antsRival.push(spawnAnt('rv'));
  buildCraftSel(); refreshInv(); refreshMats(); resizeCanvas(); clampView(); draw(); updateHud();
}
let _last=performance.now(); function loop(now){ let dt=(now-_last)/1000; _last=now; dt*=timeScale; step(dt); draw(); requestAnimationFrame(loop); }
function step(dt){
  stepWeather(dt);
  if(showTimer){ timeLeft=Math.max(0,timeLeft-dt); document.getElementById('timerText').textContent=Math.ceil(timeLeft); }
  stepPher(dt);
  const want=desiredPopulation(); if(ants.length < want){ spawnBudget += dt * 10; while(spawnBudget>=1 && ants.length<want){ ants.push(spawnAnt('me')); spawnBudget-=1; } }
  if(antsRival.length < 150){ if(Math.random()<0.4*dt) antsRival.push(spawnAnt('rv')); }
  function sensePher(gx,gy,team){ if(!inBounds(gx,gy)) return 0; const p=(team==='rv'?grid[idx(gx,gy)].pherRv:grid[idx(gx,gy)].pherMe)||{}; let A=0,R=0; for(const k in p){ const t=PH[k].type, v=p[k]; if(t==='ban'||t==='acid') R+=v*PH[k].strength; if(t==='trail'||t==='recruit') A+=v*PH[k].strength; } return A-R; }
  function stepAnt(a){
    a.sinceSteps += dt*a.speed; const need = a.changeAt;
    a.dropCooldown = Math.max(0, a.dropCooldown - dt);
    const moved = Math.hypot(a.x-(a.lastX||a.x), a.y-(a.lastY||a.y));
    if(moved < 0.2){ a.stuckT = (a.stuckT||0) + dt; if(a.stuckT>0.6){ a.aim += (Math.random()-0.5)*Math.PI; a.stuckT=0; } }
    else { a.stuckT = 0; }
    a.lastX=a.x; a.lastY=a.y;
    const gx=Math.floor(a.x/TILE), gy=Math.floor(a.y/TILE);
    const sig=sensePher(gx,gy,a.team);
    if(sig>0.02){ a.sinceSteps=0; }
    const nest=findNest(a.team);
    if(a.carry){
      const nx=nest.x*TILE+TILE/2, ny=nest.y*TILE+TILE/2; const ang=Math.atan2(ny-a.y, nx-a.x);
      a.aim = ang + (Math.random()-0.5)*0.16;
      if(a.dropCooldown<=0 && a.phCharge>0 && localTrailStrength(gx,gy,a.team) < 0.3){
        placePher(gx,gy, 'm4mp2c', 0.5, a.team);
        a.phCharge -= 1;
        a.dropCooldown = 0.20;
      }
    }else{
      if(a.sinceSteps > need && sig<=0.02){
        a.sinceSteps=0; a.aim += (Math.random()-0.5)*Math.PI;
      }else if(sig>0.02){
        a.aim += (Math.random()-0.5)*0.08;
      }
    }
    const dx=Math.cos(a.aim)*a.speed*dt, dy=Math.sin(a.aim)*a.speed*dt; let nx=a.x+dx, ny=a.y+dy;
    const cgx=Math.floor(nx/TILE), cgy=Math.floor(ny/TILE);
    if(!inBounds(cgx,cgy) || [T_WATER,T_WALL].includes(grid[idx(cgx,cgy)].type)){ a.aim += Math.PI*0.6*(Math.random()<0.5?1:-1); return; }
    a.x=nx; a.y=ny;
    sniffAt(cgx,cgy);
    const cell=grid[idx(cgx,cgy)];
    if(!a.carry && cell.type===T_FOOD){
      a.carry=true; carrying++; a.load = clone(cell.food.yield);
      a.phCharge = Math.min(a.phMax, a.phCharge + 2);
      cell.food.hp-=1; cell.food.size = Math.max(1.0, cell.food.size-0.3);
      if(cell.food.hp<=0){ cell.type=T_EMPTY; cell.food=null; placePher(cgx,cgy,'noentry',1.2,a.team); }
      if(a.phCharge>0){ placePher(cgx,cgy, 'm4mp2c', 1.0, a.team); a.phCharge -= 1; }
      if(a.team==='me'){ colonyCap = Math.min(colonyMax, colonyCap + 1); }
    }
    if(a.carry && cgx===nest.x && cgy===nest.y){
      a.carry=false; carrying=Math.max(0,carrying-1);
      if(a.team==='me'){
        scoreMe++; if(a.load){ for(const k in a.load){ mats[k]=(mats[k]||0)+a.load[k]; } refreshMats(); }
      }else{ scoreRival++; }
      a.load=null;
      if(a.phCharge>0){ placePher(cgx,cgy, 'm4mp2c', 0.4, a.team); a.phCharge -= 1; }
      a.phCharge = a.phMax;
    }
  }
  ants.forEach(stepAnt);
  antsRival.forEach(stepAnt);
  if(level===2){ stepTargets(dt); }
  if(level>=3){ stepEnemies(dt); }
  updateHud();
}
function showNextAction(label, btnText, showEnemyBtn){
  nextReady=true;
  const box=document.getElementById('nextActions'); box.style.display='flex';
  document.getElementById('nextLabel').textContent=label||'';
  const btn=document.getElementById('btnNext');
  if(btnText){ btn.style.display='inline-block'; btn.textContent=btnText; } else { btn.style.display='none'; }
  const be=document.getElementById('btnAddEnemy');
  if(showEnemyBtn){ be.style.display='inline-block'; be.onclick=function(){ enemies.push(makeEnemy(choice(['spider','gecko','roach']))); hideNextAction(); }; }
  else { be.style.display='none'; }
}
function hideNextAction(){ const box=document.getElementById('nextActions'); if(!box) return; box.style.display='none'; document.getElementById('btnNext').style.display='none'; document.getElementById('btnAddEnemy').style.display='none'; nextReady=false; }

function updateHud(){
  const meCarry = ants.reduce((n,a)=>n+(a.carry?1:0),0);
  const rvCarry = antsRival.reduce((n,a)=>n+(a.carry?1:0),0);
  const tbody=document.querySelector('#statsTable tbody');
  if(tbody){
    tbody.innerHTML = '<tr><td>æˆ‘æ–¹</td><td>'+ants.length+'</td><td>'+meCarry+'</td><td>'+scoreMe+'</td></tr>' +
                      '<tr><td>æ•µæ–¹</td><td>'+antsRival.length+'</td><td>'+rvCarry+'</td><td>'+scoreRival+'</td></tr>';
  }
  const agg={};
  for(let i=0;i<grid.length;i++){ const c=grid[i]; if(c.type===T_FOOD){ const k=c.food.type; if(!agg[k]) agg[k]={cnt:0,hp:0}; agg[k].cnt++; agg[k].hp+=c.food.hp; } }
  const fbody=document.querySelector('#foodTable tbody'); if(fbody){ fbody.innerHTML=''; }
  const order=['sugar','peanut','fish','resin','citrus','oil','berry','wax','chitin'];
  for(const k of order){ if(agg[k]){ const tr=document.createElement('tr'); tr.innerHTML='<td>'+k+'</td><td>'+agg[k].cnt+'</td><td>'+agg[k].hp+'</td>'; fbody.appendChild(tr);} }
}

/******************** äº’å‹•ï¼šç¸®æ”¾/å¹³ç§»/é¸å–® ********************/
let viewX=0, viewY=0, viewScale=1, isPanning=false, panStartX=0, panStartY=0, panViewX=0, panViewY=0, spaceDown=false;
function clampView(){ const rect=canvas.getBoundingClientRect(); const vw=rect.width/(window.devicePixelRatio||1)/viewScale; const vh=rect.height/(window.devicePixelRatio||1)/viewScale; viewX=Math.max(0, Math.min(WORLD_W - vw, viewX)); viewY=Math.max(0, Math.min(WORLD_H - vh, viewY)); }
canvas.addEventListener('contextmenu', e=>e.preventDefault());
window.addEventListener('keydown', e=>{ if(e.code==='Space') spaceDown=true; if(e.key==='r'||e.key==='R') resetGame(); if(e.key==='f'||e.key==='F') openRef(); });
window.addEventListener('keyup', e=>{ if(e.code==='Space') spaceDown=false; });
canvas.addEventListener('mousedown', function(e){ const rect=canvas.getBoundingClientRect(); function toWorld(cx,cy){ const px=(cx-rect.left)/(window.devicePixelRatio||1)/viewScale + viewX; const py=(cy-rect.top )/(window.devicePixelRatio||1)/viewScale + viewY; return {gx:Math.floor(px/TILE), gy:Math.floor(py/TILE)}; } const m=toWorld(e.clientX,e.clientY); if(e.button===1 || spaceDown){ isPanning=true; panStartX=e.clientX; panStartY=e.clientY; panViewX=viewX; panViewY=viewY; return; } if(e.button===2){ if(inBounds(m.gx,m.gy)){ grid[idx(m.gx,m.gy)].pherMe={}; } return; } if(!selectedPh) return; if((inventory[selectedPh]||0)<=0) return; placePher(m.gx,m.gy,selectedPh,1,'me'); inventory[selectedPh]--; refreshInv(); });
canvas.addEventListener('mousemove', function(e){ if(isPanning){ const dx=e.clientX-panStartX, dy=e.clientY-panStartY; const dpr=window.devicePixelRatio||1; viewX=panViewX-dx/(dpr*viewScale); viewY=panViewY-dy/(dpr*viewScale); clampView(); return; } });
window.addEventListener('mouseup', function(){ isPanning=false; });
canvas.addEventListener('wheel', function(e){ e.preventDefault(); const rect=canvas.getBoundingClientRect(); const dpr=window.devicePixelRatio||1; const mx=(e.clientX-rect.left)/dpr; const my=(e.clientY-rect.top)/dpr; const worldX = viewX + mx / viewScale; const worldY = viewY + my / viewScale; const delta = Math.sign(e.deltaY); const factor = (delta>0)? 0.9 : 1.1; const newScale = Math.min(4, Math.max(0.5, viewScale*factor)); if(newScale===viewScale) return; viewX = worldX - (mx / newScale); viewY = worldY - (my / newScale); viewScale = newScale; clampView(); }, {passive:false});
document.getElementById('btnZoomIn').onclick=function(){ const rect=canvas.getBoundingClientRect(); const cx=rect.width/2, cy=rect.height/2; zoomAround(cx,cy,1.1); };
document.getElementById('btnZoomOut').onclick=function(){ const rect=canvas.getBoundingClientRect(); const cx=rect.width/2, cy=rect.height/2; zoomAround(cx,cy,0.9); };
document.getElementById('btnZoomReset').onclick=function(){ viewScale=1; clampView(); };
function zoomAround(cx,cy,factor){ const rect=canvas.getBoundingClientRect(); const dpr=window.devicePixelRatio||1; const mx=(cx-rect.left)/dpr; const my=(cy-rect.top)/dpr; const worldX = viewX + mx / viewScale; const worldY = viewY + my / viewScale; const newScale = Math.min(4, Math.max(0.5, viewScale*factor)); if(newScale===viewScale) return; viewX = worldX - (mx / newScale); viewY = worldY - (my / newScale); viewScale = newScale; clampView(); }

/******************** åˆæˆè²»æ´›è’™ææ–™æ³• â€” ref UI ********************/
const FOOD_TO_MAT=[
  {food:'sugar', label:'è”—ç³–å¡Šï¼ˆç³–ï¼‰', yield:{O:2,C:1}, steps:['æº¶è§£â†’éæ¿¾','æ¿ƒç¸®çµæ™¶']},
  {food:'peanut', label:'èŠ±ç”Ÿç¢ï¼ˆå …æœæ²¹è„‚ï¼‰', yield:{C:2,R:1}, steps:['å£“æ¦¨â†’å†·å‡','è„«æ°´â†’ç ”ç£¨']},
  {food:'fish', label:'é­šä¹¾ç¢ï¼ˆè›‹ç™½è³ªï¼‰', yield:{N:2,C:1}, steps:['ç²‰ç¢','æ°´è§£â†’æ¿¾æ¸£']},
  {food:'resin', label:'æ¨¹è„‚', yield:{T:2,C:1}, steps:['æº¶åŠ‘èƒå–','æ¸›å£“è’¸é¤¾']},
  {food:'citrus', label:'æŸ‘æ©˜æœçš®', yield:{Ald:1,O:1,R:1}, steps:['å†·å£“â†’æŸ‘æ©˜æ²¹','é¸æ“‡æ€§æ°§åŒ–']},
  {food:'oil', label:'å‹•æ¤ç‰©æ²¹', yield:{HC:2,C:1}, steps:['çš‚åŒ–åˆ†é›¢','è£‚è§£']},
  {food:'berry', label:'æ¼¿æœ', yield:{Acid:2,O:1}, steps:['ç™¼é…µâ†’æœ‰æ©Ÿé…¸','éæ¿¾æ¿ƒç¸®']},
  {food:'wax', label:'èœ‚è Ÿ', yield:{HC:2}, steps:['ç†”èé™¤é›œ','é‡çµæ™¶']},
  {food:'chitin', label:'ç”²æ®¼ç¢', yield:{N:1,Acid:1,R:1}, steps:['å»è›‹ç™½','è„«ç¤¦ç‰©','é…¸è§£']}
];
const SYN_STEPS=[
  {name:'èƒå– / å£“æ¦¨', effect:'+10% ç”¢ç‡ï¼ˆå—æ¿•åº¦â†‘å½±éŸ¿ï¼‰'},
  {name:'æ°´è§£ / é…µè§£', effect:'é‡‹æ”¾å«æ°®/å«æ°§åŸºï¼ˆè€—æ™‚ï¼‰'},
  {name:'æ°§åŒ– / é‚„åŸ', effect:'è½‰ Ald / Acid / R å¹³è¡¡'},
  {name:'è£‚è§£', effect:'è£‚è§£æ²¹è„‚å‡º HCï¼ˆé¢¨å¼·â†’æ®ç™¼æå¤±â†‘ï¼‰'},
  {name:'é‡çµæ™¶ / ç²¾é¤¾', effect:'ç´”åº¦â†‘ä½†å›æ”¶ç‡â†“'}
];

function openRef(){
  const modal=document.getElementById('refModal'); const card=document.getElementById('refCard');
  const tabBtn=(id,label)=>'<button class="'+(id==='tabPh'?'active':'')+'" data-tab="'+id+'">'+label+'</button>';
  let phRows=''; for(const r of REF){ phRows+='<tr><td>'+r.short+'</td><td>'+r.formal+'</td><td>'+r.cls+'</td><td>'+r.source+'</td></tr>'; }
  let foodRows=''; for(const r of FOOD_TO_MAT){ foodRows+='<tr><td>'+r.label+'</td><td>'+r.food+'</td><td>'+fmtObj(r.yield)+'</td><td>'+r.steps.join(' â†’ ')+'</td></tr>'; }
  let recRows=''; for(const id in RECIPES){ const rec=RECIPES[id]; recRows+='<tr><td>'+rec.label+'</td><td>'+id+'</td><td>'+fmtObj(rec.cost)+'</td></tr>'; }
  let procRows=''; for(const s of SYN_STEPS){ procRows+='<tr><td>'+s.name+'</td><td>'+s.effect+'</td></tr>'; }

  card.innerHTML = `
    <div class="row" style="justify-content:space-between; align-items:center">
      <h2>ref</h2>
      <div class="tabbar">
        ${tabBtn('tabPh','è²»æ´›è’™')}
        ${tabBtn('tabMat','åˆæˆææ–™æ³•')}
      </div>
      <button onclick="closeRef()">é—œé–‰</button>
    </div>
    <div id="tabPh" class="tabPane">
      <div class="note">é»ä¸‹ã€Œåˆæˆææ–™æ³•ã€å¯æŸ¥çœ‹ã€Œé£Ÿç‰©â†’ææ–™ã€å…Œæ›èˆ‡ã€Œè²»æ´›è’™â†’ææ–™ã€éœ€æ±‚ã€‚</div>
      <table><thead><tr><th>ç°¡å</th><th>æ­£å¼å</th><th>é¡åˆ¥</th><th>ä¾†æºè…ºé«”</th></tr></thead><tbody>${phRows}</tbody></table>
    </div>
    <div id="tabMat" class="tabPane" style="display:none">
      <h3>é£Ÿç‰© â†’ ææ–™ å…Œæ›</h3>
      <table><thead><tr><th>é£Ÿç‰©</th><th>ä»£è™Ÿ</th><th>ææ–™ï¼ˆæ¯é¡†ç²’ï¼‰</th><th>è™•ç†æ­¥é©Ÿï¼ˆéŠæˆ²å…§æŠ½è±¡åŒ–ï¼‰</th></tr></thead><tbody>${foodRows}</tbody></table>
      <h3 style="margin-top:14px">è²»æ´›è’™ â†’ ææ–™ éœ€æ±‚</h3>
      <table><thead><tr><th>è²»æ´›è’™</th><th>ID</th><th>æ‰€éœ€ææ–™</th></tr></thead><tbody>${recRows}</tbody></table>
      <h3 style="margin-top:14px">è™•ç†æµç¨‹æç¤º</h3>
      <table><thead><tr><th>æ­¥é©Ÿ</th><th>æ•ˆæœ</th></tr></thead><tbody>${procRows}</tbody></table>
      <div class="note" style="margin-top:8px">æç¤ºï¼šæ¿•åº¦é«˜ â†’ æ®ç™¼æ…¢ï¼ˆææ–™æå¤±â†“ï¼‰ï¼›é¢¨é€Ÿå¤§ â†’ æŒ¥å‘/ä¿¡è™Ÿæ“´æ•£â†‘ï¼›ä¸‹é›¨æœƒæ´—å»éœ²å¤©æ“ä½œçš„åŠæˆå“èˆ‡è·¯å¾‘ã€‚</div>
    </div>
  `;
  modal.style.display='grid';
  const tabs=card.querySelectorAll('.tabbar button');
  tabs.forEach(btn=>btn.addEventListener('click', ()=>{
    tabs.forEach(b=>b.classList.remove('active')); btn.classList.add('active');
    const target=btn.getAttribute('data-tab');
    card.querySelector('#tabPh').style.display = (target==='tabPh')?'block':'none';
    card.querySelector('#tabMat').style.display = (target==='tabMat')?'block':'none';
  }));
}
function fmtObj(o){ return Object.keys(o).map(k=>'<span class="kbd">'+k+': '+o[k]+'</span>').join(' '); }
function closeRef(){ document.getElementById('refModal').style.display='none'; } window.closeRef=closeRef;

/******************** å•Ÿå‹• ********************/
(function(){ try{ resizeCanvas(); resetGame(); requestAnimationFrame(loop); } catch(err){ const box=document.getElementById('errorOverlay'); const pre=document.getElementById('errorText'); box.style.display='block'; pre.textContent=String(err && err.stack || err); console.error(err); } })();
</script>
</body>
</html>