<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>模式螞蟻費洛蒙策略遊戲 v0.2 — Lv1~Lv4</title>
<style>
  :root { --bg:#0f1115; --panel:#151922; --ink:#e8eefc; --muted:#9aa4b2; --accent:#77e4a0; --danger:#ff7a7a; --warn:#ffd36e; }
  html,body{height:100%; margin:0; background:var(--bg); color:var(--ink); font-family: ui-sans-serif, system-ui, -apple-system, PingFangTC, "Noto Sans TC", Segoe UI, Roboto, Helvetica, Arial;}
  #wrap{display:grid; grid-template-columns: 320px 1fr 320px; gap:10px; height:100%; padding:10px; box-sizing:border-box;}
  .panel{background:var(--panel); border-radius:14px; padding:12px; overflow:auto;}
  h2{margin:6px 0 8px; font-size:18px}
  h3{margin:12px 0 6px; font-size:14px; color:var(--muted)}
  button,select{background:#23293a; color:var(--ink); border:1px solid #2b3246; border-radius:10px; padding:6px 10px; cursor:pointer}
  button:hover{filter:brightness(1.1)}
  .row{display:flex; gap:6px; align-items:center; flex-wrap:wrap}
  .pill{border:1px solid #334; border-radius:30px; padding:4px 8px; font-size:12px}
  .stat{display:flex; justify-content:space-between; font-size:13px; padding:4px 0}
  #canvas{background:#0b0d12; border:1px solid #22283a; border-radius:12px; width:100%; height:100%}
  .ph-btn{display:flex; justify-content:space-between; align-items:center; gap:8px; width:100%}
  .ph-btn > span:first-child{font-weight:600}
  .list{display:grid; gap:6px}
  .badge{font-size:11px; padding:2px 6px; border-radius:8px; background:#223}
  .ok{color:#9ffcac}
  .warn{color:var(--warn)}
  .danger{color:var(--danger)}
  .meter{height:8px; border-radius:999px; background:#22293a; overflow:hidden}
  .meter > i{display:block; height:100%; background:linear-gradient(90deg, #6ee7b7, #93c5fd)}
  #topbar{grid-column:1/4; display:flex; align-items:center; gap:10px}
  #topbar .slot{background:var(--panel); border-radius:12px; padding:8px 10px; display:flex; align-items:center; gap:8px}
  .kbd{font-family: ui-monospace, SFMono-Regular, Menlo, monospace; background:#1b2030; border:1px solid #2b3246; border-radius:6px; padding:1px 6px; font-size:12px}
  #refModal{position:fixed; inset:0; display:none; place-items:center; background:#0008}
  #refCard{width:min(980px,92vw); height:min(80vh,680px); background:#111522; border:1px solid #2b3246; border-radius:14px; overflow:auto; padding:16px}
  table{width:100%; border-collapse:collapse; font-size:13px}
  th,td{border-bottom:1px solid #2b3246; padding:6px 8px; text-align:left}
  .grid2{display:grid; grid-template-columns: 1fr 1fr; gap:10px}
  #errorOverlay{position:fixed; inset:8px; display:none; z-index:9999; background:#1d2233; color:#ffd1d1; border:1px solid #b44; border-radius:12px; padding:12px; box-shadow:0 6px 30px #0008}
  #errorOverlay pre{white-space:pre-wrap; font-family:ui-monospace, SFMono-Regular, Menlo, monospace; font-size:12px; color:#ffd1d1}
  #testOverlay{position:fixed; bottom:8px; left:8px; background:#112015; color:#9ffcac; border:1px solid #2f7; border-radius:10px; padding:8px 10px; font-size:12px; display:none}
</style>
</head>
<body>
  <div id="wrap">
    <div id="topbar">
      <div class="slot">關卡：
        <select id="levelSel">
          <option value="1">Lv1 搬運競速</option>
          <option value="2">Lv2 蟻巢擴充</option>
          <option value="3">Lv3 蜘蛛入侵</option>
          <option value="4">Lv4 吸引+禁止解謎</option>
        </select>
        <button id="btnRestart">重新開始</button>
        <button id="btnRef">開啟 ref</button>
      </div>
      <div class="slot" id="goalSlot">目標：<span id="goalText"></span></div>
      <div class="slot">時間：<span id="timerText">0</span> 秒</div>
      <div class="slot">我方運回：<span id="scoreMe">0</span>　對手：<span id="scoreRival">0</span></div>
    </div>

    <div class="panel" id="leftPanel">
      <h2>合成與費洛蒙</h2>
      <h3>材料（由食物拆解取得）</h3>
      <div id="matRow" class="row"></div>
      <div class="meter" style="margin:6px 0 10px"><i id="loadBar" style="width:0%"></i></div>
      <h3>合成</h3>
      <div class="row">
        <select id="craftSel"></select>
        <button id="btnCraft">合成 1 瓶</button>
      </div>
      <h3>瓶庫（點地面部署）</h3>
      <div id="invList" class="list"></div>
      <h3>提示</h3>
      <div id="tipBox" style="font-size:13px; color:var(--muted)">在地圖上用滑鼠左鍵放置費洛蒙；右鍵清除一小塊殘留。</div>
    </div>

    <canvas id="canvas"></canvas>

    <div class="panel" id="rightPanel">
      <h2>資訊</h2>
      <div class="stat"><span>我方螞蟻</span><b id="antsMe">0</b></div>
      <div class="stat"><span>對手螞蟻</span><b id="antsRival">0</b></div>
      <div class="stat"><span>搬運中</span><b id="carrying">0</b></div>
      <div class="stat"><span>蜘蛛狀態</span><b id="spiderStat">—</b></div>
      <h3>已解鎖費洛蒙</h3>
      <div id="unlocked" class="list"></div>
      <h3>快捷鍵</h3>
      <div style="font-size:13px; color:var(--muted)">
        <div><span class="kbd">1-9</span> 選瓶；<span class="kbd">R</span> 重新開始；<span class="kbd">F</span> ref</div>
        <div>左鍵放置，右鍵清除；<span class="kbd">Shift</span> 長線佈署</div>
      </div>
    </div>
  </div>

  <div id="refModal">
    <div id="refCard"></div>
  </div>

  <div id="errorOverlay"><b>⚠️ 腳本錯誤</b>
    <div style="margin-top:6px">若你看到這個方塊，代表腳本在載入或執行時出錯。訊息如下：</div>
    <pre id="errorText"></pre>
  </div>
  <div id="testOverlay">自動測試：<span id="testText">執行中…</span></div>

<script>
// ————————————————————————————
//  基本資料（ref 簡名 ↔ 正式名）
// ————————————————————————————
const REF = [
  { id:'m4mp2c', short:'吡咯酸甲酯', formal:'methyl 4-methylpyrrole-2-carboxylate (M4MP2C)', cls:'路徑-短', source:'毒腺', notes:'切葉蟻經典 trail，短效但強吸引。' },
  { id:'edp', short:'乙基二甲基吡嗪（EDP）', formal:'3-ethyl-2,5-dimethylpyrazine', cls:'路徑/警戒', source:'（多為毒腺）', notes:'可作短效路徑與局部警戒。' },
  { id:'faranal', short:'Faranal', formal:'faranal', cls:'路徑-長', source:'杜佛氏腺', notes:'法老蟻長效幹線。' },
  { id:'mono1', short:'Monomorine I', formal:'monomorine I', cls:'招募-短', source:'毒腺', notes:'近距快速集結。' },
  { id:'noentry', short:'禁止混合物', formal:'no-entry blend（法老蟻抑制型）', cls:'禁止', source:'毒腺', notes:'封鎖無效路徑、形成單向流' },
  { id:'formic', short:'蟻酸', formal:'formic acid', cls:'防禦', source:'毒腺', notes:'對節肢動物具刺激性，與烴類並用增效鋪展' },
  { id:'c11', short:'十一烷', formal:'n-undecane', cls:'警戒/增效', source:'杜佛氏腺/毒腺', notes:'與酸同在可提升覆蓋與持續' },
  { id:'farnesene', short:'α-法呢烯', formal:'(Z,E)-α-farnesene', cls:'招募', source:'杜佛氏腺', notes:'收穫蟻等招募訊號' },
  { id:'dolich', short:'多利克二醛', formal:'dolichodial', cls:'路徑', source:'腹端腺', notes:'阿根廷蟻 trail 主成分之一' },
  { id:'irido', short:'Iridomyrmecin', formal:'iridomyrmecin', cls:'路徑', source:'腹端腺', notes:'阿根廷蟻 trail 主成分之一' },
  { id:'z9', short:'Z9-16 醛', formal:'(Z)-9-hexadecenal', cls:'增益', source:'腹端腺', notes:'微量增益跟隨效率' }
];

// ————————————————————————————
//  遊戲參數
// ————————————————————————————
const TILE = 18; // 每格像素
const W = 36, H = 28; // 格數（約 648x504）
const CANVAS_W = W*TILE, CANVAS_H = H*TILE;
const ANT_MAX = 120; const RIVAL_MAX = 110; // 每關會調
let level = 1, timeLeft = 120;

// 地圖格類型
const T_EMPTY=0, T_WATER=1, T_FOOD=2, T_NEST_ME=3, T_NEST_RIVAL=4, T_WALL=5, T_SPIDER=6, T_TARGET=7;

// 材料庫 & 配方（對照設計草案 §7）
const MATERIALS = ['C','O','N','R','T','Ald','Acid','HC','LAC'];
const RECIPES = {
  m4mp2c: {label:'吡咯酸甲酯', cost:{C:1,O:1,N:1}},
  edp: {label:'乙基二甲基吡嗪', cost:{N:2,R:1,C:1}},
  faranal: {label:'Faranal', cost:{T:2,Ald:1,HC:1}},
  mono1: {label:'Monomorine I', cost:{N:1,R:1,HC:1}},
  noentry: {label:'禁止混合物', cost:{Ald:1,Acid:1,HC:1}},
  formic: {label:'蟻酸', cost:{Acid:2}},
  c11: {label:'十一烷', cost:{HC:2}},
  farnesene: {label:'α-法呢烯', cost:{T:2,HC:1}},
  dolich: {label:'多利克二醛', cost:{Ald:2,R:1}},
  irido: {label:'Iridomyrmecin', cost:{LAC:1,T:1}},
  z9: {label:'Z9-16 醛', cost:{Ald:1,HC:1}}
};

// 解鎖表（每關）
const UNLOCK = {
  1:['m4mp2c','edp'],
  2:['faranal','mono1','noentry','farnesene','m4mp2c','edp'],
  3:['formic','c11','m4mp2c','faranal','mono1'],
  4:['faranal','noentry','dolich','irido','z9','m4mp2c']
};

// 參數：費洛蒙屬性
const PH = {
  m4mp2c:{type:'trail',   color:'#68f',     strength:2, radius:1, halfLife:20, amplify:0.4},
  edp:{    type:'trail',   color:'#9bf',     strength:2, radius:1, halfLife:15, amplify:0.3},
  faranal:{type:'trail',   color:'#6fa',     strength:3, radius:1, halfLife:60, amplify:0.5},
  mono1:{  type:'recruit', color:'#aff',     strength:2, radius:1, halfLife:18, amplify:0.4},
  noentry:{type:'ban',     color:'#f77',     strength:3, radius:1, halfLife:30, amplify:0.2},
  formic:{ type:'acid',    color:'#f55',     strength:2, radius:2, halfLife:8,  amplify:0.2},
  c11:{    type:'alkane',  color:'#fc8',     strength:0, radius:2, halfLife:20, amplify:0.0},
  farnesene:{type:'recruit',color:'#dff76a', strength:2, radius:1, halfLife:25, amplify:0.4},
  dolich:{ type:'trail',   color:'#a5f',     strength:2, radius:1, halfLife:25, amplify:0.4},
  irido:{  type:'trail',   color:'#c7f',     strength:2, radius:1, halfLife:25, amplify:0.4},
  z9:{     type:'boost',   color:'#fff38a',  strength:0, radius:1, halfLife:12, amplify:0.0}
};

// ————————————————————————————
//  狀態容器
// ————————————————————————————
const canvas = document.getElementById('canvas');
canvas.width = CANVAS_W; canvas.height = CANVAS_H;
const ctx = canvas.getContext('2d');

let grid=[], foodLeft=0, scoreMe=0, scoreRival=0;
let ants=[], antsRival=[]; let carrying=0; let spider=null; let targetZone=[];
let mats={}, inventory={}, unlocked=[], selectedPh=null, placingLine=null;

// ————————————————————————————
//  工具
// ————————————————————————————
const inBounds=(x,y)=>x>=0&&y>=0&&x<W&&y<H;
const idx=(x,y)=>y*W+x;
function randInt(a,b){return Math.floor(Math.random()*(b-a+1))+a}
function choice(arr){return arr[Math.floor(Math.random()*arr.length)]}

// ————————————————————————————
//  地圖生成
// ————————————————————————————
function makeMap_Lv1(){
  baseRandomMap(0.12); // water ratio
  placeNests();
  scatterFood([{type:'sugar',yield:{O:2,C:1}}, {type:'peanut',yield:{C:2,R:1}}, {type:'fish',yield:{N:2,C:1}}], 28);
  setGoal('在 120 秒內，搬回的顆粒數量要超過對手。');
  timeLeft=120; spider=null; targetZone=[];
}
function makeMap_Lv2(){
  baseRandomMap(0.08);
  placeNests();
  scatterFood([{type:'resin',yield:{T:2,C:1}},{type:'citrus',yield:{Ald:1,O:1,R:1}},{type:'oil',yield:{HC:2,C:1}}], 26);
  // 指定新巢區域
  targetZone=[]; const tx=randInt(4,W-5), ty=randInt(4,H-5);
  for(let y=-2;y<=2;y++) for(let x=-2;x<=2;x++){
    if(inBounds(tx+x,ty+y)) grid[idx(tx+x,ty+y)].type=T_TARGET; targetZone.push({x:tx+x,y:ty+y});
  }
  setGoal('在標示區內建立新蟻巢（集結築巢進度 100%）。');
  timeLeft=150; spider=null;
}
function makeMap_Lv3(){
  baseRandomMap(0.05);
  placeNests();
  scatterFood([{type:'berry',yield:{Acid:2,O:1}}, {type:'wax',yield:{HC:2}}, {type:'chitin',yield:{N:1,Acid:1,R:1}}], 24);
  // 蜘蛛
  spider={x:randInt(3,W-4), y:randInt(3,H-4), hp:120, cooldown:0, mode:'patrol', t:0, killCount:0};
  setGoal('維持運輸並擊退蜘蛛 3 次（或擊倒）。善用「蟻酸 + 十一烷」增效區。');
  timeLeft=120;
}
function makeMap_Lv4(){
  // 迷宮：先清空，再生成牆與通道
  grid=new Array(W*H).fill(0).map(function(){return {type:T_WALL, food:null, pher:{}, smell:0};});
  // carve corridors（隨機 DFS）
  function carve(x,y){
    grid[idx(x,y)].type=T_EMPTY;
    const dirs=[[1,0],[-1,0],[0,1],[0,-1]].sort(function(){return Math.random()-0.5});
    for(let i=0;i<dirs.length;i++){
      const dx=dirs[i][0], dy=dirs[i][1];
      const nx=x+dx*2, ny=y+dy*2;
      if(inBounds(nx,ny) && grid[idx(nx,ny)].type===T_WALL){
        grid[idx(x+dx,y+dy)].type=T_EMPTY; carve(nx,ny);
      }
    }
  }
  var sx=(randInt(1,W-2)|1), sy=(randInt(1,H-2)|1); // 取奇數座標
  carve(sx,sy);
  // 水塊少量點綴
  for(let i=0;i<100;i++){
    const x=randInt(0,W-1), y=randInt(0,H-1);
    if(grid[idx(x,y)].type===T_EMPTY && Math.random()<0.08) grid[idx(x,y)].type=T_WATER;
  }
  // 放置巢與食物
  const nestMe={x:2,y:2}, nestR={x:W-3,y:H-3};
  grid[idx(nestMe.x,nestMe.y)].type=T_NEST_ME;
  grid[idx(nestR.x,nestR.y)].type=T_NEST_RIVAL;
  // 食物: 放在迷宮深處與岔路
  for(let i=0;i<14;i++){
    const x=randInt(3,W-4), y=randInt(3,H-4);
    if(grid[idx(x,y)].type===T_EMPTY){
      grid[idx(x,y)].type=T_FOOD;
      grid[idx(x,y)].food=choice([
        {type:'resin',yield:{T:2,C:1}},
        {type:'citrus',yield:{Ald:1,O:1,R:1}},
        {type:'oil',yield:{HC:2,C:1}}
      ]);
      foodLeft++;
    }
  }
  setGoal('使用「Faranal + 禁止」在迷宮中引導螞蟻找到食物並搬回。控制錯誤率與用量。');
  timeLeft=140; spider=null; targetZone=[];
}

function baseRandomMap(waterRatio){
  grid=new Array(W*H).fill(0).map(function(){return {type:T_EMPTY, food:null, pher:{}, smell:0};});
  for(let y=0;y<H;y++){
    for(let x=0;x<W;x++){
      if(Math.random()<waterRatio) grid[idx(x,y)].type=T_WATER;
    }
  }
  // 隨機不規則邊界：多塊水域沿邊緣
  for(let i=0;i<Math.floor((W+H)/2); i++){
    const side=Math.random()<0.5?0:W-1; const y=randInt(0,H-1); grid[idx(side,y)].type=T_WATER;
  }
}
function placeNests(){
  // 左上/右下
  const mx=2, my=2, rx=W-3, ry=H-3;
  grid[idx(mx,my)].type=T_NEST_ME; grid[idx(rx,ry)].type=T_NEST_RIVAL;
}
function scatterFood(list, count){
  foodLeft=0;
  for(let i=0;i<count;i++){
    const x=randInt(1,W-2), y=randInt(1,H-2);
    if(grid[idx(x,y)].type===T_EMPTY){ grid[idx(x,y)].type=T_FOOD; grid[idx(x,y)].food=choice(list); foodLeft++; }
  }
}

// ————————————————————————————
//  角色
// ————————————————————————————
function spawnAnt(team){
  const pos=findNest(team);
  return {team:team, x:pos.x, y:pos.y, carry:false, hp:1, mood:'explore', cd:0};
}
function findNest(team){
  for(let y=0;y<H;y++) for(let x=0;x<W;x++){
    const t=grid[idx(x,y)].type;
    if(team==='me' && t===T_NEST_ME) return {x:x,y:y};
    if(team==='rv' && t===T_NEST_RIVAL) return {x:x,y:y};
  }
  return {x:1,y:1};
}

// ————————————————————————————
//  遊戲流程
// ————————————————————————————
function resetGame(){
  ants=[]; antsRival=[]; inventory={}; mats={}; scoreMe=0; scoreRival=0; carrying=0; spider=null; placingLine=null;
  unlocked = UNLOCK[level].slice(0); selectedPh = unlocked[0]||null;
  for(let i=0;i<MATERIALS.length;i++){ mats[MATERIALS[i]]=0; }
  if(level===1) makeMap_Lv1();
  if(level===2) makeMap_Lv2();
  if(level===3) makeMap_Lv3();
  if(level===4) makeMap_Lv4();
  for(let i=0;i<80;i++) ants.push(spawnAnt('me'));
  for(let i=0;i<70;i++) antsRival.push(spawnAnt('rv'));
  updateUI(); draw();
}

let last=performance.now();
function loop(now){ const dt=(now-last)/1000; last=now; step(dt); draw(); requestAnimationFrame(loop); }

function step(dt){
  // 時間
  timeLeft=Math.max(0, timeLeft-dt);
  if(timeLeft===0){ checkWin(); }

  // 費洛蒙衰減
  for(let i=0;i<grid.length;i++){
    const cell=grid[i]; if(!cell.pher) continue; for(const k in cell.pher){ cell.pher[k]-=dt*(1/PH[k].halfLife); if(cell.pher[k]<=0) delete cell.pher[k]; }
  }

  // 競爭巢：偶爾塗短效 trail
  if(Math.random()<0.04){ const a=choice(antsRival); if(a){ placePher(a.x,a.y,'m4mp2c',0.6); } }

  // 螞蟻行為
  const walkers = ants.concat(antsRival);
  for(let i=0;i<walkers.length;i++){
    const a=walkers[i]; if(a.cd>0){a.cd-=dt; continue;}
    const moves=[[1,0],[-1,0],[0,1],[0,-1]];
    let best=null, bestScore=-1e9; const baseNoise=(Math.random()*0.3);
    for(let j=0;j<moves.length;j++){
      const dx=moves[j][0], dy=moves[j][1];
      const nx=a.x+dx, ny=a.y+dy; if(!inBounds(nx,ny)) continue; const c=grid[idx(nx,ny)]; if(c.type===T_WATER||c.type===T_WALL) continue;
      // 勢能 A-R
      let A=0,R=0; if(c.pher){
        for(const k in c.pher){ const v=c.pher[k]; const t=PH[k].type; if(t==='trail'||t==='recruit') A+=v*PH[k].strength; if(t==='ban') R+=v*PH[k].strength; if(t==='acid') R+=v*0.5; }
      }
      // 三重增益：dolich+irido+z9 在 2x2 內
      let triBoost= hasTriBoost(nx,ny) ? 0.5 : 0;
      const score = A - R + triBoost + baseNoise + (Math.random()*0.1);
      if(score>bestScore){ bestScore=score; best=[nx,ny]; }
    }
    if(best){ a.x=best[0]; a.y=best[1]; }

    // 事件：食物
    const cell=grid[idx(a.x,a.y)];
    if(!a.carry && cell.type===T_FOOD){
      a.carry=true; carrying++;
      const yv=cell.food.yield; for(const k in yv){ if(a.team==='me'){ mats[k]=(mats[k]||0)+yv[k]; } }
      cell._hp = (cell._hp||2)-1; if(cell._hp<=0){ cell.type=T_EMPTY; cell.food=null; foodLeft--; }
      if(a.team==='me') placePher(a.x,a.y, selectedOrDefaultTrail(), 0.6);
    }
    // 事件：回巢
    const t=grid[idx(a.x,a.y)].type;
    if(a.carry && ((a.team==='me'&&t===T_NEST_ME)||(a.team==='rv'&&t===T_NEST_RIVAL))){ a.carry=false; carrying=Math.max(0,carrying-1); if(a.team==='me') scoreMe++; else scoreRival++; }

    // 回敷：成功路徑
    if(Math.random()<0.1){ if(a.team==='me') placePher(a.x,a.y, selectedOrDefaultTrail(), 0.3); }
  }

  // 蜘蛛（Lv3）
  if(spider){
    spider.t+=dt; if(spider.cooldown>0) spider.cooldown-=dt;
    if(spider.mode==='patrol'){
      if(Math.random()<0.3){ const m=[[1,0],[-1,0],[0,1],[0,-1]]; const dir=choice(m); const nx=spider.x+dir[0], ny=spider.y+dir[1]; if(inBounds(nx,ny)&&grid[idx(nx,ny)].type!==T_WATER&&grid[idx(nx,ny)].type!==T_WALL){ spider.x=nx; spider.y=ny; }}
      if(Math.random()<0.2){ const near=ants.find(function(p){return Math.hypot(p.x-spider.x,p.y-spider.y)<4}); if(near) spider.mode='rush'; }
    } else if(spider.mode==='rush'){
      const tgt=ants.slice().sort(function(a,b){return Math.hypot(a.x-spider.x,a.y-spider.y)-Math.hypot(b.x-spider.x,b.y-spider.y)})[0];
      if(tgt){ const dx=Math.sign(tgt.x-spider.x), dy=Math.sign(tgt.y-spider.y); const nx=spider.x+dx, ny=spider.y+dy; if(inBounds(nx,ny)&&grid[idx(nx,ny)].type!==T_WATER&&grid[idx(nx,ny)].type!==T_WALL){ spider.x=nx; spider.y=ny; }}
      let dot=0; if(acidBoost(spider.x,spider.y)) dot+=20*dt; else dot+=3*dt; spider.hp-=dot; if(spider.hp<=0){ spider.mode='down'; timeLeft+=10; spider.killCount++; spider.hp=120; spider.x=randInt(2,W-3); spider.y=randInt(2,H-3); spider.mode='patrol'; }
    }
    document.getElementById('spiderStat').textContent = 'HP '+spider.hp.toFixed(0)+'｜擊退 '+(spider.killCount||0);
  } else { document.getElementById('spiderStat').textContent='—'; }

  // UI
  document.getElementById('timerText').textContent = Math.ceil(timeLeft);
  document.getElementById('scoreMe').textContent = scoreMe;
  document.getElementById('scoreRival').textContent = scoreRival;
  document.getElementById('carrying').textContent = carrying;
  document.getElementById('antsMe').textContent = ants.length;
  document.getElementById('antsRival').textContent = antsRival.length;
}

function selectedOrDefaultTrail(){
  if(selectedPh && (PH[selectedPh].type==='trail'||PH[selectedPh].type==='recruit')) return selectedPh; return 'm4mp2c';
}

function hasTriBoost(x,y){
  // 檢查 2x2 內是否同時存在 dolich, irido, z9
  const set={};
  for(let dy=0;dy<2;dy++) for(let dx=0;dx<2;dx++){
    const nx=x+dx, ny=y+dy; if(!inBounds(nx,ny)) continue; const p=grid[idx(nx,ny)].pher; if(!p) continue; if(p.dolich>0.01) set.dolich=1; if(p.irido>0.01) set.irido=1; if(p.z9>0.01) set.z9=1;
  }
  return !!(set.dolich&&set.irido&&set.z9);
}
function acidBoost(x,y){
  // 同格或鄰格同時存在 formic + c11
  for(let dy=-1;dy<=1;dy++) for(let dx=-1;dx<=1;dx++){
    const nx=x+dx, ny=y+dy; if(!inBounds(nx,ny)) continue; const p=grid[idx(nx,ny)].pher||{}; if((p.formic||0)>0.05 && (p.c11||0)>0.05) return true;
  }
  return false;
}

// ————————————————————————————
//  佈署 & 合成
// ————————————————————————————
function placePher(x,y,key,amt){ if(amt===undefined) amt=1; if(!inBounds(x,y)) return; const cell=grid[idx(x,y)]; if(cell.type===T_WATER||cell.type===T_WALL) return; cell.pher[key]=(cell.pher[key]||0)+amt; }
canvas.addEventListener('contextmenu', function(e){ e.preventDefault(); });
canvas.addEventListener('mousedown', function(e){
  const rect=canvas.getBoundingClientRect(); const x=Math.floor((e.clientX-rect.left)/TILE), y=Math.floor((e.clientY-rect.top)/TILE);
  if(e.button===2){ if(inBounds(x,y) && grid[idx(x,y)].pher) grid[idx(x,y)].pher={}; return; }
  if(!selectedPh) return;
  if((inventory[selectedPh]||0)<=0){ tip('瓶庫不足，請先合成。'); return; }
  placingLine={sx:x, sy:y}; placePher(x,y,selectedPh,1); inventory[selectedPh]--; refreshInv();
});
canvas.addEventListener('mousemove', function(e){
  if(!placingLine) return; if(!selectedPh) return; if((inventory[selectedPh]||0)<=0) return;
  const rect=canvas.getBoundingClientRect(); const x=Math.floor((e.clientX-rect.left)/TILE), y=Math.floor((e.clientY-rect.top)/TILE);
  if(!inBounds(x,y)) return; placePher(x,y,selectedPh,0.8); inventory[selectedPh]--; refreshInv();
});
window.addEventListener('mouseup', function(){ placingLine=null; });

function tryCraft(){
  const id=document.getElementById('craftSel').value; const need=RECIPES[id].cost; for(const k in need){ if((mats[k]||0)<need[k]){ tip('材料不足'); return; } }
  for(const k in need){ mats[k]-=need[k]; } inventory[id]=(inventory[id]||0)+1; refreshInv(); refreshMats();
}

// ————————————————————————————
//  勝負
// ————————————————————————————
function checkWin(){
  let pass=false, msg='';
  if(level===1){ pass = scoreMe>scoreRival; msg= pass? 'Lv1 通過！你搬得比對手多。':'挑戰失敗：對手搬得更多。'; }
  if(level===2){ const count = ants.filter(function(a){return targetZone.some(function(t){return t.x===a.x&&t.y===a.y;});}).length; pass = count>6; msg= pass? 'Lv2 通過！新巢建立成功。':'未達成：新巢區集結不足。'; }
  if(level===3){ pass = (spider&&spider.killCount||0)>=3; msg= pass? 'Lv3 通過！成功擊退蜘蛛三次。':'未達成：擊退次數不足。'; }
  if(level===4){ pass = scoreMe>=14; msg= pass? 'Lv4 通過！成功引導並搬回食物。':'未達成：回收不足，試試吸引+禁止雙訊號。'; }
  alert(msg);
}

// ————————————————————————————
//  繪圖
// ————————————————————————————
function draw(){
  ctx.clearRect(0,0,CANVAS_W,CANVAS_H);
  for(let y=0;y<H;y++){
    for(let x=0;x<W;x++){
      const c=grid[idx(x,y)]; let col='#0c101a';
      if(c.type===T_WATER) col='#0a1830';
      if(c.type===T_WALL)  col='#0a0a10';
      if(c.type===T_TARGET) col='#10231a';
      ctx.fillStyle=col; ctx.fillRect(x*TILE,y*TILE,TILE,TILE);
      if(c.pher){ for(const k in c.pher){ ctx.fillStyle=PH[k].color; ctx.globalAlpha=Math.min(0.7, c.pher[k]); ctx.fillRect(x*TILE,y*TILE,TILE,TILE); ctx.globalAlpha=1; } }
      if(c.type===T_FOOD){ ctx.fillStyle='#ffd36e'; ctx.fillRect(x*TILE+4,y*TILE+4,TILE-8,TILE-8); }
    }
  }
  for(let y=0;y<H;y++) for(let x=0;x<W;x++){ const t=grid[idx(x,y)].type; if(t===T_NEST_ME){ drawNest(x,y,'#77e4a0'); } else if(t===T_NEST_RIVAL){ drawNest(x,y,'#e477a0'); } }
  if(spider){ ctx.fillStyle='#9ad'; ctx.beginPath(); ctx.arc(spider.x*TILE+TILE/2, spider.y*TILE+TILE/2, TILE*0.45,0,Math.PI*2); ctx.fill(); }
  ants.forEach(function(a){drawAnt(a,'#9ffcac')}); antsRival.forEach(function(a){drawAnt(a,'#ff9fbd')});
}
function drawNest(x,y,color){ ctx.fillStyle=color; ctx.fillRect(x*TILE+2,y*TILE+2,TILE-4,TILE-4); }
function drawAnt(a,color){ ctx.fillStyle=color; ctx.fillRect(a.x*TILE+6,a.y*TILE+6,6,6); if(a.carry){ ctx.fillStyle='#ffd36e'; ctx.fillRect(a.x*TILE+4,a.y*TILE+4,3,3); } }

// ————————————————————————————
//  UI 綁定
// ————————————————————————————
function refreshMats(){ const row=document.getElementById('matRow'); row.innerHTML=''; for(let i=0;i<MATERIALS.length;i++){ const k=MATERIALS[i]; const d=document.createElement('div'); d.className='pill'; d.textContent=k+': '+(mats[k]||0); row.appendChild(d);} }
function refreshInv(){
  const list=document.getElementById('invList'); list.innerHTML='';
  for(let i=0;i<unlocked.length;i++){
    const id=unlocked[i]; const div=document.createElement('div'); div.className='ph-btn row';
    const left=document.createElement('span'); left.textContent=(RECIPES[id]&&RECIPES[id].label)||id;
    const right=document.createElement('span'); right.innerHTML='<span class="badge">'+(inventory[id]||0)+'</span> <span class="badge" style="background:'+PH[id].color+'">●</span> <span class="badge">'+(i+1)+'</span>';
    div.appendChild(left); div.appendChild(right); div.style.border='1px solid #2b3246'; div.style.padding='6px 8px'; div.style.borderRadius='10px';
    div.onclick=function(){ selectedPh=id; tip('選擇：'+((RECIPES[id]&&RECIPES[id].label)||id)); };
    list.appendChild(div);
  }
}
function refreshUnlock(){ const area=document.getElementById('unlocked'); area.innerHTML=''; for(let i=0;i<unlocked.length;i++){ const id=unlocked[i]; const d=document.createElement('div'); d.innerHTML='<b>'+((RECIPES[id]&&RECIPES[id].label)||id)+'</b> <span class="badge">'+PH[id].type+'</span>'; area.appendChild(d); } }
function buildCraftSel(){ const sel=document.getElementById('craftSel'); sel.innerHTML=''; for(let i=0;i<unlocked.length;i++){ const id=unlocked[i]; const opt=document.createElement('option'); opt.value=id; opt.textContent=(RECIPES[id]&&RECIPES[id].label)||id; sel.appendChild(opt); } }
function tip(t){ document.getElementById('tipBox').textContent=t; }
function setGoal(t){ document.getElementById('goalText').textContent=t; }

// 上方與側欄事件
 document.getElementById('btnCraft').onclick=function(){ tryCraft(); refreshMats(); };
 document.getElementById('btnRestart').onclick=function(){ resetGame(); };
 document.getElementById('levelSel').onchange=function(e){ level=parseInt(e.target.value,10); resetGame(); };
 window.addEventListener('keydown', function(e){
   if(e.key==='r' || e.key==='R'){ resetGame(); }
   if(e.key==='f' || e.key==='F'){ openRef(); }
   const n=parseInt(e.key,10); if(n>=1 && n<=9){ const id=unlocked[n-1]; if(id){ selectedPh=id; tip('選擇：'+((RECIPES[id]&&RECIPES[id].label)||id)); } }
 });
 document.getElementById('btnRef').onclick=function(){ openRef(); };

function openRef(){
  const modal=document.getElementById('refModal'); const card=document.getElementById('refCard');
  var listHTML='';
  for(let i=0;i<unlocked.length;i++){
    const id=unlocked[i]; listHTML += '<li style="margin:4px 0"><span class="pill">'+((RECIPES[id]&&RECIPES[id].label)||id)+'</span> <span class="badge">'+PH[id].type+'</span></li>';
  }
  var tableRows='';
  for(let i=0;i<REF.length;i++){
    var r=REF[i]; tableRows+='<tr><td>'+r.short+'</td><td>'+r.formal+'</td><td>'+r.cls+'</td><td>'+r.source+'</td><td>'+r.notes+'</td></tr>';
  }
  card.innerHTML = ''+
    '<div class="row" style="justify-content:space-between; align-items:center"><h2>ref — 螞蟻費洛蒙（簡名 → 正式名）</h2><button onclick="closeRef()">關閉</button></div>'+
    '<div class="grid2">'+
      '<div><h3>遊戲用簡名（點瓶查看）</h3><ul style="list-style:none; padding-left:0">'+listHTML+'</ul></div>'+
      '<div><h3>說明</h3><p style="color:var(--muted)">此處僅摘要。完整內容（來源腺體、真實物種、協同案例）已加入 <b>ref</b> 檔案（你在對話中要求的那份）。</p><p style="color:var(--muted)">協同規則：<br>・吸引+禁止 → 路網剪枝<br>・蟻酸+十一烷 → 酸霧增效<br>・多利克二醛+Iridomyrmecin+Z9-16 醛 → 跟隨增益</p></div>'+
    '</div>'+
    '<h3>正式對照</h3><table><thead><tr><th>簡名</th><th>正式名</th><th>類別</th><th>來源腺體</th><th>備註</th></tr></thead><tbody>'+tableRows+'</tbody></table>';
  modal.style.display='grid';
}
function closeRef(){ document.getElementById('refModal').style.display='none'; }
window.closeRef=closeRef; // 讓按鈕可呼叫

function updateUI(){ refreshMats(); refreshInv(); refreshUnlock(); buildCraftSel(); document.getElementById('loadBar').style.width='0%'; }

// ————————————————————————————
//  自動測試（基本健檢）
// ————————————————————————————
function runTests(){
  const tests=[]; function ok(name,cond){ tests.push({name:name, pass:!!cond}); }
  // T1: UNLOCK 的 key 都能對應到 PH 與 RECIPES
  let allRefs=true; for(const lv in UNLOCK){ const arr=UNLOCK[lv]; for(let i=0;i<arr.length;i++){ const id=arr[i]; if(!PH[id]) allRefs=false; if(!RECIPES[id] && id!=='z9' && id!=='c11' && id!=='formic' && id!=='noentry' && id!=='mono1' && id!=='faranal' && id!=='m4mp2c' && id!=='edp' && id!=='farnesene' && id!=='dolich' && id!=='irido'){ allRefs=false; } } }
  ok('UNLOCK 參照存在性', allRefs);
  // T2: placePher 基本功能
  const cell0=grid[idx(0,0)]; cell0.pher={}; placePher(0,0,'m4mp2c',1); ok('placePher 寫入', cell0.pher.m4mp2c>0);
  // T3: 三重增益檢測
  const cx=5, cy=5; grid[idx(cx,cy)].pher={dolich:1}; grid[idx(cx+1,cy)].pher={irido:1}; grid[idx(cx,cy+1)].pher={z9:1}; ok('hasTriBoost 2x2', hasTriBoost(cx,cy));
  // T4: 酸霧增益檢測
  grid[idx(10,10)].pher={formic:0.2, c11:0.2}; ok('acidBoost 相同格', acidBoost(10,10));
  // T5: REF/PH/RECIPES 基本長度
  ok('REF 條目 >= 10', REF.length>=10); ok('PH 條目 >= 10', Object.keys(PH).length>=10); ok('RECIPES 條目 >= 10', Object.keys(RECIPES).length>=10);

  const passed = tests.filter(function(t){return t.pass}).length;
  const overlay=document.getElementById('testOverlay'); const txt=document.getElementById('testText');
  overlay.style.display='block';
  txt.textContent = passed+'/'+tests.length+' 通過：'+tests.map(function(t){return (t.pass?'✅ ':'❌ ')+t.name}).join('｜');
}

// ————————————————————————————
//  啟動（帶錯誤攔截）
// ————————————————————————————
(function(){
  try{
    resetGame(); requestAnimationFrame(loop); runTests();
  }catch(err){
    const box=document.getElementById('errorOverlay'); const pre=document.getElementById('errorText');
    box.style.display='block'; pre.textContent=String(err && err.stack || err);
    console.error(err);
  }
})();
</script>
</body>
</html>
