<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>模式螞蟻 v0.89c</title>
<style>
:root{--bg:#0f1115;--ink:#e8eefc;--muted:#9aa4b2;--panel:#111523;--line:#283048;--accent:#77e4a0}
*{box-sizing:border-box}html,body{height:100%;margin:0;background:var(--bg);color:var(--ink);
font-family:ui-sans-serif,system-ui,-apple-system,"Noto Sans TC",Segoe UI,Roboto,Helvetica,Arial}
#wrap{display:grid;grid-template-columns:minmax(0,1fr) 280px;gap:8px;height:100vh;padding:8px}
#stage{position:relative;overflow:hidden;border-radius:12px;background:#0b0d12}
#cv{position:absolute;inset:0;display:block;width:100%;height:100%;background:#0b0d12;cursor:grab}
#svg{position:absolute;inset:0;pointer-events:none}
#panel{display:grid;gap:8px;overflow:auto}
.sec{background:var(--panel);border:1px solid var(--line);border-radius:10px;padding:8px}
.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;justify-content:space-between}
button,select,input[type=range]{background:#1b2132;color:var(--ink);border:1px solid var(--line);
border-radius:10px;padding:6px 10px;cursor:pointer;font-size:16px}
.mini{font-size:13px;color:var(--muted)}
.gwrap{display:flex;gap:6px;align-items:center;justify-content:space-between}
.gcol{display:flex;flex-direction:column;align-items:center;gap:2px}
.gcol b{font-size:14px}
canvas.g{width:60px;height:60px;background:#0c1020;border-radius:10px}
/* 我方顏色 */
.antMe .antBody{fill:#9ffcac;stroke:#0006;stroke-width:.6}
.antMe .leg{stroke:#91d9b1;stroke-width:.7;stroke-linecap:round;transform-box:fill-box;transform-origin:center}
/* 敵方灰白 */
.antEn .antBody{fill:#d7dbe3;stroke:#0006;stroke-width:.6}
.antEn .leg{stroke:#cfd3da;stroke-width:.7;stroke-linecap:round;transform-box:fill-box;transform-origin:center}
@keyframes legA{0%{transform:rotate(18deg)}50%{transform:rotate(-18deg)}100%{transform:rotate(18deg)}}
@keyframes legB{0%{transform:rotate(-18deg)}50%{transform:rotate(18deg)}100%{transform:rotate(-18deg)}}
#err{position:fixed;right:12px;bottom:12px;display:none;background:#1d2233;color:#ffd1d1;border:1px solid #b44;border-radius:12px;padding:10px;box-shadow:0 6px 30px #0008;z-index:9999;max-width:55vw}
#err pre{white-space:pre-wrap;font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px;margin:6px 0 0}
#refModal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:9998}
#refCard{width:min(880px,90vw);max-height:85vh;overflow:auto;background:#0e1322;border:1px solid #2a334a;border-radius:12px;padding:16px}
#refCard h2{margin:6px 0 10px} #refCard table{width:100%;border-collapse:collapse} #refCard td,#refCard th{border:1px solid #2a334a;padding:6px}
</style>
</head>
<body>
<div id="wrap">
  <div id="stage">
    <canvas id="cv"></canvas>
    <svg id="svg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" preserveAspectRatio="xMidYMid slice">
      <defs>
        <!-- 我方螞蟻 -->
        <g id="antSpriteMe" class="antMe">
          <ellipse class="antBody" cx="0" cy="0" rx="3.4" ry="2.5"></ellipse>
          <ellipse class="antBody" cx="-5.6" cy="0" rx="2.4" ry="1.8"></ellipse>
          <ellipse class="antBody" cx="-9.3" cy="0" rx="1.7" ry="1.3"></ellipse>
          <g class="leg" style="animation:legA var(--legdur,0.6s) linear infinite">
            <polyline points="-5.6,-0.6 -7.6,-2.0 -9.6,-3.0" fill="none"></polyline>
            <polyline points="-3.4,-0.8 -5.4,-2.4 -7.4,-3.2" fill="none"></polyline>
            <polyline points="-1.2,-0.3 -3.0,-1.8 -4.8,-2.6" fill="none"></polyline>
          </g>
          <g class="leg" style="animation:legB var(--legdur,0.6s) linear infinite">
            <polyline points="-5.6,0.6 -7.6,2.0 -9.6,3.0" fill="none"></polyline>
            <polyline points="-3.4,0.8 -5.4,2.4 -7.4,3.2" fill="none"></polyline>
            <polyline points="-1.2,0.3 -3.0,1.8 -4.8,2.6" fill="none"></polyline>
          </g>
          <polyline class="leg" points="-10.5,-0.2 -12.4,-1.6 -13.6,-2.0" fill="none"></polyline>
          <polyline class="leg" points="-10.5,0.2 -12.4,1.6 -13.6,2.0" fill="none"></polyline>
        </g>
        <!-- 敵方螞蟻（灰白） -->
        <g id="antSpriteEn" class="antEn">
          <ellipse class="antBody" cx="0" cy="0" rx="3.4" ry="2.5"></ellipse>
          <ellipse class="antBody" cx="-5.6" cy="0" rx="2.4" ry="1.8"></ellipse>
          <ellipse class="antBody" cx="-9.3" cy="0" rx="1.7" ry="1.3"></ellipse>
          <g class="leg" style="animation:legA var(--legdur,0.6s) linear infinite">
            <polyline points="-5.6,-0.6 -7.6,-2.0 -9.6,-3.0" fill="none"></polyline>
            <polyline points="-3.4,-0.8 -5.4,-2.4 -7.4,-3.2" fill="none"></polyline>
            <polyline points="-1.2,-0.3 -3.0,-1.8 -4.8,-2.6" fill="none"></polyline>
          </g>
          <g class="leg" style="animation:legB var(--legdur,0.6s) linear infinite">
            <polyline points="-5.6,0.6 -7.6,2.0 -9.6,3.0" fill="none"></polyline>
            <polyline points="-3.4,0.8 -5.4,2.4 -7.4,3.2" fill="none"></polyline>
            <polyline points="-1.2,0.3 -3.0,1.8 -4.8,2.6" fill="none"></polyline>
          </g>
          <polyline class="leg" points="-10.5,-0.2 -12.4,-1.6 -13.6,-2.0" fill="none"></polyline>
          <polyline class="leg" points="-10.5,0.2 -12.4,1.6 -13.6,2.0" fill="none"></polyline>
        </g>
      </defs>
      <g id="antsMe"></g>
      <g id="antsEn"></g>
    </svg>
  </div>
  <div id="panel">
    <div class="sec row">
      <div style="flex:1;text-align:center"><b>關卡</b><div><select id="lv"><option value="1">Lv1</option></select></div></div>
      <div style="flex:1;text-align:center"><button id="reset">reset</button></div>
      <div style="flex:1;text-align:center"><button id="ref">ref</button></div>
    </div>
    <div class="sec">
      <div class="gwrap">
        <div class="gcol"><b>風速</b><canvas class="g" id="gWind" width="60" height="60"></canvas></div>
        <div class="gcol"><b>溼度</b><canvas class="g" id="gHum" width="60" height="60"></canvas></div>
        <div class="gcol"><b>時間</b><canvas class="g" id="gTime" width="60" height="60"></canvas></div>
        <div class="gcol"><b>視窗</b><canvas class="g" id="gZoom" width="60" height="60" title="點擊切換全景/1:1"></canvas></div>
      </div>
      <div class="row" style="margin-top:6px">
        <span class="mini">1×</span>
        <input id="spd" type="range" min="1" max="100" value="1" style="flex:1"/>
        <span class="mini">100×</span>
      </div>
      <div class="mini" style="text-align:center;margin-top:2px">累積時間：<span id="acc">00:00:00:00</span></div>
    </div>
    <div class="sec">
      <table style="width:100%;border-collapse:collapse">
        <thead><tr><th></th><th>螞蟻</th><th>分</th></tr></thead>
        <tbody>
          <tr><td>我</td><td id="meA">0</td><td id="meS">0</td></tr>
          <tr><td>敵</td><td id="enA">0</td><td id="enS">0</td></tr>
        </tbody>
      </table>
      <div class="row" style="margin-top:6px">
        <button id="btnScatter" title="當場上沒有食物時顯示">灑食物</button>
        <button id="btnPlace">放置食物</button>
        <span id="placeHint" class="mini">（點地圖放一個食物）</span>
      </div>
    </div>
    <div class="sec">
      <div class="row">
        <b>材料</b>
        <div class="mini">C:<span id="mC">0</span> H:<span id="mH">0</span> O:<span id="mO">0</span> N:<span id="mN">0</span></div>
      </div>
      <div id="needs" class="row" style="margin-top:4px"></div>
      <div class="row" style="margin-top:6px">
        <select id="craft"></select>
        <div>
          <button id="btnCraft">生成</button>
          <button id="btnCraft10">生成×10</button>
        </div>
      </div>
      <div id="inv" class="row mini" style="margin-top:6px"></div>
    </div>
  </div>
</div>

<div id="refModal">
  <div id="refCard">
    <div class="row" style="justify-content:space-between;align-items:center">
      <h2 style="margin:0">Ref — 法老蟻費洛蒙系統（概念性模型）</h2>
      <button onclick="document.getElementById('refModal').style.display='none'">關閉</button>
    </div>
    <h3>三種覓食途徑費洛蒙</h3>
    <table>
      <thead><tr><th>名稱</th><th>持續時間（無風）</th><th>功能</th><th>顏色（顯示）</th></tr></thead>
      <tbody>
        <tr><td>Faranal</td><td>約 5 小時</td><td>主導航／回巢骨幹，含<strong>向量</strong>與<strong>食物剩餘次數</strong></td><td>淡黃 α0.9</td></tr>
        <tr><td>Monomorine</td><td>約 30 分</td><td>發現食物時快速招募，含<strong>食物座標</strong></td><td>淡橘 α0.9</td></tr>
        <tr><td>No-entry blend</td><td>約 1 小時</td><td>剪枝／禁止，標示資源枯竭或錯路</td><td>紅 α0.9</td></tr>
      </tbody>
    </table>
    <h3>費洛蒙合成材料（簡化為元素）</h3>
    <table>
      <thead><tr><th>目標</th><th>需要</th></tr></thead>
      <tbody>
        <tr><td>Faranal</td><td>C×6, H×10, O×1</td></tr>
        <tr><td>Monomorine</td><td>C×6, H×13, N×1</td></tr>
        <tr><td>No-entry</td><td>C×4, H×8, O×2</td></tr>
        <tr><td>螞蟻個體</td><td>C×60, H×120, O×30, N×20</td></tr>
      </tbody>
    </table>
  </div>
</div>

<div id="err"><b>⚠️ 腳本錯誤</b><pre id="errTxt"></pre></div>

<script>
"use strict";
window.addEventListener('error', e=>{ const b=document.getElementById('err'); const p=document.getElementById('errTxt'); b.style.display='block'; p.textContent=(e.message||'')+"\\n"+(e.filename||'')+':'+(e.lineno||'')+':'+(e.colno||''); });

(function(){
const TILE=16, W=160, H=96, WW=W*TILE, HH=H*TILE;
const T_EMPTY=0,T_WATER=1,T_FOOD=2,T_NEST_ME=3,T_NEST_EN=4;
const idx=(x,y)=>y*W+x, inB=(x,y)=>x>=0&&y>=0&&x<W&&y<H, clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
const rint=(a,b)=>Math.floor(Math.random()*(b-a+1))+a;

const cv=document.getElementById('cv'), cx=cv.getContext('2d');
const svg=document.getElementById('svg'), gMe=document.getElementById('antsMe'), gEn=document.getElementById('antsEn');

// camera
const cam={x:0,y:0,s:1};
function fit(){ const r=cv.getBoundingClientRect(); const d=window.devicePixelRatio||1; cv.width=Math.max(1,Math.floor(r.width*d)); cv.height=Math.max(1,Math.floor(r.height*d)); }
window.addEventListener('resize', ()=>{ fit(); draw(); updateView(); });
function updateView(){ const d=window.devicePixelRatio||1; const w=cv.width/d, h=cv.height/d; svg.setAttribute('viewBox','0 0 '+w+' '+h); }
function worldToScreen(x,y){ return {x:(x-cam.x)*cam.s, y:(y-cam.y)*cam.s}; }
function screenToWorld(x,y){ return {x:x/cam.s+cam.x, y:y/cam.s+cam.y}; }

// drag & wheel
let dragging=false, lastM=null, placeFoodMode=false;
cv.addEventListener('mousedown',e=>{ dragging=true; lastM={x:e.clientX,y:e.clientY}; cv.style.cursor='grabbing'; });
window.addEventListener('mouseup',()=>{ dragging=false; cv.style.cursor='grab'; });
window.addEventListener('mousemove',e=>{ if(!dragging) return; const dx=(e.clientX-lastM.x)/cam.s, dy=(e.clientY-lastM.y)/cam.s; cam.x-=dx; cam.y-=dy; lastM={x:e.clientX,y:e.clientY}; });
cv.addEventListener('wheel',e=>{ e.preventDefault(); const rect=cv.getBoundingClientRect(); const x=(e.clientX-rect.left); const y=(e.clientY-rect.top); const pt=screenToWorld(x,y); const k=Math.exp(-e.deltaY*0.0015); const ns=clamp(cam.s*k, 0.2, 6); cam.x=pt.x-(pt.x-cam.x)*cam.s/ns; cam.y=pt.y-(pt.y-cam.y)*cam.s/ns; cam.s=ns; },{passive:false});
let zoomAll=false;
function fitAll(){ const d=window.devicePixelRatio||1; const w=cv.width/d, h=cv.height/d; const sx=w/WW, sy=h/HH; const s=Math.min(sx,sy); cam.s=s; cam.x=0; cam.y=0; }
function fit1(){ cam.s=1; cam.x=0; cam.y=0; }

// REF & recipes (alpha=0.9)
const REF=[{id:'faranal',life:5*3600,color:'rgba(255,243,166,0.9)'},{id:'monomorine',life:30*60,color:'rgba(255,178,102,0.9)'},{id:'noentry',life:60*60,color:'rgba(255,64,64,0.9)'}];
const REC={faranal:{label:'Faranal',cost:{C:6,H:10,O:1}},monomorine:{label:'Monomorine',cost:{C:6,H:13,N:1}},noentry:{label:'No-entry',cost:{C:4,H:8,O:2}},ant:{label:'螞蟻',cost:{C:60,H:120,O:30,N:20}}};
const PH={}; REF.forEach(r=>PH[r.id]={life:r.life,color:r.color});

let mats={C:0,H:0,O:0,N:0}, inv={faranal:2,monomorine:2,noentry:1};
let grid=[], antsMe=[], antsEn=[], foods=[], scoreMe=0, scoreEn=0;
let weather={wind:1.8,dir:0,hum:55};
let sim=0, tscale=1;

// map
function cell(){ return {type:T_EMPTY, pher:{}, food:null, kind:null}; }
function riverNet(){
  let x=rint(4,W-5), y=1, dir=Math.PI/2, width=2;
  for(let i=0;i<W*1.6;i++){
    const gx=Math.floor(x), gy=Math.floor(y);
    if(inB(gx,gy)){ for(let oy=-Math.floor(width/2);oy<=Math.floor(width/2);oy++){ const yy=gy+oy; if(inB(gx,yy)) grid[idx(gx,yy)].type=T_WATER; } }
    if(i%28===0){ const bx=gx+rint(-2,2), by=gy+rint(-2,2); if(inB(bx,by)) grid[idx(bx,by)].type=T_EMPTY; }
    if(Math.random()<0.05){
      const d2=dir+(Math.random()<0.5?-1:1)*(0.6+Math.random()*0.6); let sx=x, sy=y;
      for(let k=0;k<18;k++){ sx+=Math.cos(d2)*1.0; sy+=Math.sin(d2)*0.8; const gx2=Math.floor(sx), gy2=Math.floor(sy);
        if(!inB(gx2,gy2)) break; grid[idx(gx2,gy2)].type=T_WATER; if(k%18===0){ const bx2=gx2+rint(-1,1), by2=gy2+rint(-1,1); if(inB(bx2,by2)) grid[idx(bx2,by2)].type=T_EMPTY; } }
    }
    dir+=(Math.random()-0.5)*0.4; width=clamp(width+(Math.random()<0.5?-1:1),1,3);
    x+=Math.cos(dir)*1.1; y+=Math.sin(dir)*0.9;
    if(!inB(Math.floor(x),Math.floor(y))) break;
  }
}
function initMap(){
  grid=new Array(W*H); for(let i=0;i<grid.length;i++) grid[i]=cell();
  riverNet();
  grid[idx(4,4)].type=T_NEST_ME; grid[idx(W-5,H-5)].type=T_NEST_EN;
  placeFoods( Math.floor(W*H*0.0012) );
}
function isLand(x,y){ return inB(x,y) && grid[idx(x,y)].type!==T_WATER; }
const FOODK=['fish','peanut','cater','resin','citrus','beetle'];
function addFoodAt(x,y,cap,kind){
  const gx=Math.floor(x), gy=Math.floor(y);
  if(!inB(gx,gy) || !isLand(gx,gy)) return false;
  if(grid[idx(gx,gy)].type!==T_EMPTY) return false;
  grid[idx(gx,gy)].type=T_FOOD; grid[idx(gx,gy)].food={times:cap}; grid[idx(gx,gy)].kind=kind;
  foods.push({x:gx,y:gy,cap,kind}); return true;
}
function placeFoods(n){
  foods.length=0;
  let tries=0;
  while(foods.length<n && tries<n*200){
    tries++;
    const x=rint(6,W-7), y=rint(6,H-7);
    if(!isLand(x,y)) continue;
    if(grid[idx(x,y)].type!==T_EMPTY) continue;
    if(Math.hypot(x-4,y-4)<8 || Math.hypot(x-(W-5),y-(H-5))<8) continue;
    const cap=rint(6,20), kind=FOODK[rint(0,FOODK.length-1)];
    addFoodAt(x,y,cap,kind);
  }
}
function foodCount(){ let c=0; for(let i=0;i<grid.length;i++) if(grid[i].type===T_FOOD) c++; return c; }

// pheromones
function ensureP(b,k){ return b[k]||(b[k]={s:0,s0:0,vx:0,vy:0,tx:null,ty:null,qty:null}); }
function placeP(gx,gy,id,amt,vx,vy,tx,ty,qty){
  if(!inB(gx,gy)) return; if(grid[idx(gx,gy)].type===T_WATER) return;
  const e=ensureP(grid[idx(gx,gy)].pher,id);
  if(id==='faranal'){ e.s=amt; e.s0=Math.max(e.s0,amt); e.vx=vx||0; e.vy=vy||0; e.tx=(tx==null?e.tx:tx); e.ty=(ty==null?e.ty:ty); e.qty=(qty==null?e.qty:qty); }
  else { e.s+=amt; e.s0=Math.max(e.s0,e.s); e.vx+=vx||0; e.vy+=vy||0; if(id==='monomorine'){ e.tx=(tx==null?e.tx:tx); e.ty=(ty==null?e.ty:ty);} }
}
function halfLife(id){ const base=(PH[id]?.life)||1800; const T=base/Math.max(1,weather.wind); return T/2; }
function stepPher(dt){
  for(let i=0;i<grid.length;i++){
    const p=grid[i].pher; for(const k in p){ const e=p[k]; const hl=halfLife(k); const f=Math.pow(0.5, dt/Math.max(1e-6,hl)); e.s*=f; if(e.s<0.004) delete p[k]; }
  }
}

// ants
function nest(team){ return team==='en'? {x:W-5,y:H-5} : {x:4,y:4}; }
function spawnAnt(team){
  const n=nest(team), px=n.x*TILE+TILE/2, py=n.y*TILE+TILE/2;
  return {x:px,y:py,aim:Math.random()*Math.PI*2,speed:26+Math.random()*8,state:'forage',drop:0,target:null,team,stuck:0};
}
function sense(gx,gy,ax,ay,st){
  if(!inB(gx,gy)) return {vx:0,vy:0,mag:0}; const p=grid[idx(gx,gy)].pher; let vx=0,vy=0,mag=0;
  for(const k in p){
    const e=p[k];
    if(k==='faranal' && e.tx!=null && e.ty!=null && st==='forage'){
      const dx=e.tx*TILE+TILE/2-ax, dy=e.ty*TILE+TILE/2-ay, L=Math.hypot(dx,dy)||1;
      vx+=(dx/L)*Math.max(0.6,e.s)*2.2; vy+=(dy/L)*Math.max(0.6,e.s)*2.2; mag+=e.s; continue;
    }
    const sgn=(k==='noentry')?-1:1; vx+=sgn*e.vx*1.2; vy+=sgn*e.vy*1.2; mag+=e.s;
  }
  return {vx,vy,mag};
}

// clamp + bounce (無環接)
function clampBounce(a){
  let bounced=false;
  if(a.x<0){ a.x=0; a.aim = Math.PI - a.aim; bounced=true; }
  if(a.x>=WW){ a.x=WW-1e-3; a.aim = Math.PI - a.aim; bounced=true; }
  if(a.y<0){ a.y=0; a.aim = -a.aim; bounced=true; }
  if(a.y>=HH){ a.y=HH-1e-3; a.aim = -a.aim; bounced=true; }
  if(bounced) a.aim += (Math.random()-0.5)*0.4;
}

function stepAnt(a,dt){
  const gx=Math.floor(a.x/TILE), gy=Math.floor(a.y/TILE);
  const vec=sense(gx,gy,a.x,a.y,a.state);
  const n=nest(a.team);
  let sVX=(vec.mag>0.02? vec.vx:0), sVY=(vec.mag>0.02? vec.vy:0);

  if(a.state==='carry'){
    const dn=Math.atan2(n.y*TILE+TILE/2-a.y, n.x*TILE+TILE/2-a.x);
    sVX+=Math.cos(dn)*3.0; sVY+=Math.sin(dn)*3.0;
    if(a.drop<=0 && a.target){
      const fx=a.target.gx, fy=a.target.gy;
      const ang=Math.atan2(fy*TILE+TILE/2-a.y, fx*TILE+TILE/2-a.x);
      placeP(gx,gy,'faranal',1.2,Math.cos(ang),Math.sin(ang),fx,fy,a.target.qty);
      a.drop=0.12;
    } else a.drop-=dt;
  }

  if(sVX!==0 || sVY!==0){
    let turn=((Math.atan2(sVY, sVX) - a.aim + Math.PI*3)%(Math.PI*2))-Math.PI;
    a.aim += turn;
  }else if(Math.random()<0.01){
    a.aim += (Math.random()-0.5)*Math.PI*2;
  }

  const sp=a.speed*dt;
  let nx=a.x+Math.cos(a.aim)*sp, ny=a.y+Math.sin(a.aim)*sp;

  let cNext=null;
  if(nx>=0 && nx<WW && ny>=0 && ny<HH){
    cNext = grid[idx(Math.floor(nx/TILE),Math.floor(ny/TILE))];
  }
  if(cNext && cNext.type===T_WATER){
    if(a.stuck>3){
      nx=a.x+Math.cos(a.aim)*sp*0.2; ny=a.y+Math.sin(a.aim)*sp*0.2;
    }else{
      a.stuck+=dt; a.aim += (Math.random()<0.5?1:-1)*Math.PI/2; return;
    }
  }else{
    a.stuck=Math.max(0,a.stuck-dt*0.5);
  }

  a.x=nx; a.y=ny;
  clampBounce(a);

  const cgx=Math.floor(a.x/TILE), cgy=Math.floor(a.y/TILE);
  const c= inB(cgx,cgy) ? grid[idx(cgx,cgy)] : null;
  if(c && a.state==='forage' && c.type===T_FOOD && c.food && c.food.times>0){
    a.state='carry'; a.target={gx:cgx,gy:cgy,qty:c.food.times};
    c.food.times--; if(c.food.times<=0){ c.type=T_EMPTY; c.food=null; c.kind=null; placeP(a.target.gx,a.target.gy,'noentry',2,0,0,null,null,null); }
    mats.C+=3; mats.H+=5; mats.O+=1; mats.N+=1; refreshMats();
    for(let oy=-1;oy<=1;oy++) for(let ox=-1;ox<=1;ox++){ const gx2=a.target.gx+ox, gy2=a.target.gy+oy; if(inB(gx2,gy2)) placeP(gx2,gy2,'monomorine',1.0,0,0,gx2,gy2,null); }
  }
  const nestPos=nest(a.team);
  if(a.state==='carry' && Math.floor(a.x/TILE)===nestPos.x && Math.floor(a.y/TILE)===nestPos.y){
    a.state='forage'; a.target=null; if(a.team==='en') scoreEn++; else scoreMe++;
  }
}

// draw
function drawHouse(o,x,y,s,fill){ o.save(); o.translate(x,y); o.fillStyle=fill; o.strokeStyle="#0006"; o.lineWidth=1; o.beginPath(); o.rect(-s*0.6,-s*0.3,s*1.2,s*0.9); o.fill(); o.stroke(); o.beginPath(); o.moveTo(-s*0.8,-s*0.3); o.lineTo(0,-s*0.9); o.lineTo(s*0.8,-s*0.3); o.closePath(); o.fill(); o.stroke(); o.restore(); }

function syncGroup(group,list,isEnemy){
  const spriteUnits=14;                  // 圖稿寬度單位
  const targetWorldPx=TILE*0.7;          // 1:1 視野下的期望寬度
  const pxOnScreen = cam.s * targetWorldPx;
  const scale = Math.max(0.08, pxOnScreen / spriteUnits);

  while(group.children.length<list.length){ const u=document.createElementNS('http://www.w3.org/2000/svg','use'); u.setAttributeNS('http://www.w3.org/1999/xlink','href', isEnemy?'#antSpriteEn':'#antSpriteMe'); group.appendChild(u); }
  while(group.children.length>list.length) group.removeChild(group.lastChild);
  for(let i=0;i<list.length;i++){
    const a=list[i], u=group.children[i];
    const sc=worldToScreen(a.x,a.y);
    const deg=a.aim*180/Math.PI+180;
    const period=Math.max(0.2,0.9*(24/Math.max(8,a.speed)));
    u.style.setProperty('--legdur', period.toFixed(2)+'s');
    u.setAttribute('transform','translate('+sc.x+','+sc.y+') rotate('+deg+') scale('+scale+')');
  }
}

function foodScale(times){ const mult=Math.max(1,Math.min(20,times)); const s=Math.pow(Math.log(mult)/Math.log(3),2); return 1+ s; }
function drawFoodIcon(o,kind,cx,cy,times){
  const s=foodScale(times);
  o.save(); o.translate(cx,cy); o.scale(s,s); o.globalAlpha=0.8; o.fillStyle="rgba(200,205,215,0.55)"; o.strokeStyle="rgba(255,255,255,0.15)"; o.lineWidth=1;
  if(kind==='fish'){ o.beginPath(); o.ellipse(0,0,7,4,0,0,6.283); o.fill(); o.stroke(); o.beginPath(); o.moveTo(5,0); o.lineTo(10,-3); o.lineTo(10,3); o.closePath(); o.fill(); o.stroke(); }
  else if(kind==='peanut'){ o.beginPath(); o.ellipse(-2,0,3.5,5,0,0,6.283); o.ellipse(2,0,3.5,5,0,0,6.283); o.fill(); o.stroke(); }
  else if(kind==='cater'){ for(let i=0;i<5;i++){ o.beginPath(); o.ellipse(-6+i*3,0,2.2,2.6,0,0,6.283); o.fill(); o.stroke(); } }
  else if(kind==='resin'){ o.beginPath(); o.moveTo(-6,2); o.quadraticCurveTo(0,-8,6,2); o.quadraticCurveTo(0,7,-6,2); o.closePath(); o.fill(); o.stroke(); }
  else if(kind==='citrus'){ o.beginPath(); o.arc(0,0,6,0,6.283); o.fill(); o.stroke(); o.beginPath(); o.moveTo(0,-6); o.lineTo(0,6); o.moveTo(-6,0); o.lineTo(6,0); o.stroke(); }
  else if(kind==='beetle'){ o.beginPath(); o.ellipse(0,0,6,4,0,0,6.283); o.fill(); o.stroke(); o.beginPath(); o.moveTo(-6,0); o.lineTo(6,0); o.stroke(); }
  else { o.beginPath(); o.arc(0,0,6,0,6.283); o.fill(); o.stroke(); }
  o.restore();
}

function draw(){
  const d=window.devicePixelRatio||1; cx.setTransform(1,0,0,1,0,0); cx.clearRect(0,0,cv.width,cv.height);
  cx.save(); cx.scale(d,d);
  cx.fillStyle='#0c101a'; cx.fillRect(0,0,cv.width/d,cv.height/d);
  cx.translate(-cam.x*cam.s, -cam.y*cam.s); cx.scale(cam.s, cam.s);

  // pheromones (pixel dots)
  for(let y=0;y<H;y++) for(let x=0;x<W;x++){
    const p=grid[idx(x,y)].pher;
    for(const k in p){
      const e=p[k]; if(e.s<=0.01) continue;
      cx.fillStyle=PH[k]?.color||'rgba(255,255,255,0.9)';
      const dots = Math.min(40, Math.max(1, Math.floor(e.s*6)));
      for(let i=0;i<dots;i++){
        const px = x*TILE + Math.random()*TILE;
        const py = y*TILE + Math.random()*TILE;
        cx.fillRect(px, py, 1, 1);
      }
    }
  }

  // water / food / nests
  for(let y=0;y<H;y++) for(let x=0;x<W;x++){
    const c=grid[idx(x,y)];
    if(c.type===T_WATER){ cx.fillStyle='#0a1830'; cx.fillRect(x*TILE,y*TILE,TILE,TILE); }
    else if(c.type===T_FOOD){
      drawFoodIcon(cx, c.kind||'peanut', x*TILE+TILE/2, y*TILE+TILE/2, c.food.times);
      cx.fillStyle='rgba(240,245,255,0.95)'; cx.font='10px ui-sans-serif'; cx.fillText(String(c.food.times), x*TILE+4, y*TILE+12);
    } else if(c.type===T_NEST_ME){ drawHouse(cx,x*TILE+TILE/2,y*TILE+TILE/2,TILE*0.7,'#77e4a0'); }
    else if(c.type===T_NEST_EN){ drawHouse(cx,x*TILE+TILE/2,y*TILE+TILE/2,TILE*0.7,'#bfc6d6'); }
  }
  cx.restore();

  // ants
  syncGroup(gMe,antsMe,false); 
  syncGroup(gEn,antsEn,true);
}

// gauges
const gWind=document.getElementById('gWind').getContext('2d');
const gHum=document.getElementById('gHum').getContext('2d');
const gTime=document.getElementById('gTime').getContext('2d');
const gZoom=document.getElementById('gZoom').getContext('2d');
const spd=document.getElementById('spd'); spd.addEventListener('input',e=>{ tscale=Number(e.target.value)||1; });
function angClock(deg){ return (-90+deg)*Math.PI/180; }
function drawWind(){ const o=gWind,w=60,h=60; o.setTransform(1,0,0,1,0,0); o.clearRect(0,0,w,h); o.translate(w/2,h/2); o.strokeStyle="#2b3246"; o.lineWidth=1.2; o.beginPath(); o.arc(0,0,26,0,Math.PI*2); o.stroke(); const a=angClock((weather.dir%360+360)%360); o.fillStyle="#cbd3e3"; o.beginPath(); o.arc(Math.cos(a)*22,Math.sin(a)*22,3,0,Math.PI*2); o.fill(); o.fillStyle="#cbd3e3"; o.font="bold 13px ui-sans-serif"; o.textAlign="center"; o.textBaseline="middle"; o.fillText(weather.wind.toFixed(1),0,0); }
function drawHum(){ const o=gHum,w=60,h=60; o.setTransform(1,0,0,1,0,0); o.clearRect(0,0,w,h); o.translate(w/2,h/2); o.strokeStyle="#2b3246"; o.lineWidth=1.2; o.beginPath(); o.arc(0,0,26,0,Math.PI*2); o.stroke(); const t=Math.max(0,Math.min(1,weather.hum/100)); const start=210, span=300, end=(start+span*t)%360; const ro=26, ri=18, steps=60; o.fillStyle="#6e7890"; o.globalAlpha=0.6; o.beginPath(); for(let i=0;i<=steps;i++){ const d=(end>=start)? (start+(end-start)*i/steps):(start+(360-start+end)*i/steps); const a=angClock(d%360); const x=Math.cos(a)*ro, y=Math.sin(a)*ro; if(i===0) o.moveTo(x,y); else o.lineTo(x,y);} for(let j=steps;j>=0;j--){ const d2=(end>=start)? (start+(end-start)*j/steps):(start+(360-start+end)*j/steps); const a2=angClock(d2%360); const x2=Math.cos(a2)*ri, y2=Math.sin(a2)*ri; o.lineTo(x2,y2);} o.closePath(); o.fill(); o.globalAlpha=1; o.fillStyle="#cbd3e3"; o.font="bold 13px ui-sans-serif"; o.textAlign="center"; o.textBaseline="middle"; o.fillText(Math.round(weather.hum)+'%',0,0); }
function taipeiNow(){ const fmt=new Intl.DateTimeFormat('zh-TW',{timeZone:'Asia/Taipei',hour12:false,year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit',second:'2-digit'}); const parts=fmt.formatToParts(new Date()); const part=t=>Number((parts.find(p=>p.type===t)||{value:"0"}).value); return new Date(part('year'),part('month')-1,part('day'),part('hour'),part('minute'),part('second')); }
let base=null; function drawTime(){ if(!base) base=taipeiNow(); const o=gTime,w=60,h=60; o.setTransform(1,0,0,1,0,0); o.clearRect(0,0,w,h); o.translate(w/2,h/2); o.strokeStyle="#2b3246"; o.lineWidth=1.2; o.beginPath(); o.arc(0,0,26,0,Math.PI*2); o.stroke(); const t=(tscale>1)? new Date(base.getTime()+sim*1000) : taipeiNow(); const s=t.getSeconds(), m=t.getMinutes(), h0=t.getHours(); const aS=angClock(s/60*360), aM=angClock((m+s/60)/60*360), aH=angClock(((h0%12)+m/60)/12*360); o.strokeStyle="#77e4a0"; o.lineWidth=3; o.beginPath(); o.moveTo(0,0); o.lineTo(Math.cos(aH)*14,Math.sin(aH)*14); o.stroke(); o.strokeStyle="#ffd36e"; o.lineWidth=2; o.beginPath(); o.moveTo(0,0); o.lineTo(Math.cos(aM)*20,Math.sin(aM)*20); o.stroke(); o.strokeStyle="#e8eefc"; o.lineWidth=1; o.beginPath(); o.moveTo(0,0); o.lineTo(Math.cos(aS)*22,Math.sin(aS)*22); o.stroke(); const tot=Math.floor(sim); const dd=Math.floor(tot/86400), hh=Math.floor((tot%86400)/3600), mm=Math.floor((tot%3600)/60), ss=tot%60; document.getElementById('acc').textContent=String(dd).padStart(2,'0')+':'+String(hh).padStart(2,'0')+':'+String(mm).padStart(2,'0')+':'+String(ss).padStart(2,'0'); gTime.canvas.onclick=()=>{ tscale=1; document.getElementById('spd').value='1'; }; }
function drawZoom(){ const o=gZoom,w=60,h=60; o.setTransform(1,0,0,1,0,0); o.clearRect(0,0,w,h); o.translate(w/2,h/2); o.strokeStyle="#2b3246"; o.lineWidth=1.2; o.beginPath(); o.arc(0,0,26,0,Math.PI*2); o.stroke(); o.fillStyle="#cbd3e3"; o.font="bold 13px ui-sans-serif"; o.textAlign="center"; o.textBaseline="middle"; o.fillText("全景",0,0); gZoom.canvas.onclick=()=>{ zoomAll=!zoomAll; if(zoomAll) fitAll(); else fit1(); draw(); updateView(); }; }

// humidity diurnal update
function humTargetByHour(h){
  // 最低約 13 點，最高約清晨 5 點
  const rad = (h/24)*2*Math.PI;
  const base = 65 - 20*Math.sin(rad + Math.PI/2); // 5點 ~85, 13點 ~45
  return clamp(base, 25, 95);
}

// UI
document.getElementById('reset').onclick=reset;
document.getElementById('ref').onclick=()=>{ document.getElementById('refModal').style.display='flex'; };
document.getElementById('btnCraft').onclick=()=>craft(1);
document.getElementById('btnCraft10').onclick=()=>craft(10);
document.getElementById('btnScatter').onclick=()=>{ if(foodCount()===0){ placeFoods(Math.floor(W*H*0.0008)); } updateFoodUI(); };
document.getElementById('btnPlace').onclick=()=>{ placeFoodMode=!placeFoodMode; document.getElementById('placeHint').style.display=placeFoodMode?'inline':'none'; };
cv.addEventListener('click',e=>{ const r=cv.getBoundingClientRect(); const x=(e.clientX-r.left); const y=(e.clientY-r.top); const w=screenToWorld(x,y); const gx=Math.floor(w.x/TILE), gy=Math.floor(w.y/TILE); if(!inB(gx,gy)) return; if(placeFoodMode){ addFoodAt(gx,gy,rint(6,20),FOODK[rint(0,FOODK.length-1)]); placeFoodMode=false; document.getElementById('placeHint').style.display='none'; return; } const id=document.getElementById('craft').value; if(id==='ant') return; if((inv[id]||0)<=0) return; placeP(gx,gy,id,2.0,1,0, id==='monomorine'?gx:null, id==='monomorine'?gy:null, null); inv[id]--; refreshInv(); refreshNeeds(); });

function updateFoodUI(){
  document.getElementById('btnScatter').style.display = (foodCount()===0)?'inline-block':'none';
}

function craft(times){
  const id=document.getElementById('craft').value, need=REC[id].cost||{};
  for(const k in need){ if((mats[k]||0) < need[k]*times) return; }
  for(const k in need){ mats[k]-=need[k]*times; }
  if(id==='ant'){ for(let i=0;i<times;i++) antsMe.push(spawnAnt('me')); } else { inv[id]=(inv[id]||0)+times; }
  refreshMats(); refreshInv(); refreshNeeds();
}

function buildSel(){ const s=document.getElementById('craft'); s.innerHTML=''; ['faranal','monomorine','noentry','ant'].forEach(id=>{ const o=document.createElement('option'); o.value=id; o.textContent=REC[id].label; s.appendChild(o); }); s.onchange=refreshNeeds; }
function refreshMats(){ mC.textContent=String(mats.C||0); mH.textContent=String(mats.H||0); mO.textContent=String(mats.O||0); mN.textContent=String(mats.N||0); }
function refreshNeeds(){ const box=document.getElementById('needs'); box.innerHTML=''; const need=(REC[document.getElementById('craft').value].cost||{}); ['C','H','O','N'].forEach(k=>{ const has=mats[k]||0, req=need[k]||0; const sp=document.createElement('span'); sp.className='mini'; sp.style.fontWeight='900'; sp.style.marginRight='8px'; sp.style.color=(has>=req)?'#e8eefc':'#ff8e8e'; sp.textContent=k+': 需'+req; box.appendChild(sp); }); }
function refreshInv(){ const row=document.getElementById('inv'); row.innerHTML=''; ['faranal','monomorine','noentry'].forEach(id=>{ const b=document.createElement('button'); b.textContent=REC[id].label; b.onclick=()=>{ document.getElementById('craft').value=id; refreshNeeds(); }; row.appendChild(b); const n=document.createElement('span'); n.textContent='×'+(inv[id]||0); n.className='mini'; row.appendChild(n); }); }

// loop
let last=performance.now(), windTick=0, minTick=0;
function loop(now){
  const dt=((now-last)/1000)*tscale; last=now; sim+=dt;
  try{
    minTick+=dt; windTick+=dt;
    if(minTick>=60){ minTick=0; weather.dir=(weather.dir + (Math.random()*120-60))%360; }
    if(windTick>=10){ windTick=0; const bands=Math.random(); let target=1+Math.random()*2; if(bands>0.6 && bands<=0.8) target=3+Math.random()*3; else if(bands>0.8) target=6+Math.random()*3; weather.wind += (target-weather.wind)*0.35; }

    // 溼度：依小時目標值趨近 + 輕微雜訊（±10%）
    const tNow = new Date();
    const hr = tNow.getHours() + tNow.getMinutes()/60;
    const tgt = humTargetByHour(hr);
    const noise = (Math.random()-0.5)*2; // -1..1%
    weather.hum += (tgt - weather.hum)*0.025*dt + noise*0.1*dt;
    weather.hum = clamp(weather.hum, 20, 95);

    stepPher(dt);
    for(let i=0;i<antsMe.length;i++) stepAnt(antsMe[i],dt);
    for(let j=0;j<antsEn.length;j++) stepAnt(antsEn[j],dt);

    draw(); drawWind(); drawHum(); drawTime(); drawZoom();
    meA.textContent=String(antsMe.length); enA.textContent=String(antsEn.length);
    meS.textContent=String(scoreMe); enS.textContent=String(scoreEn);

    updateFoodUI();
  }catch(err){ const b=document.getElementById('err'); const p=document.getElementById('errTxt'); b.style.display='block'; p.textContent=String(err && err.stack || err); }
  requestAnimationFrame(loop);
}

// reset
function reset(){
  mats={C:0,H:0,O:0,N:0}; inv={faranal:2,monomorine:2,noentry:1};
  antsMe=[]; antsEn=[]; foods=[]; scoreMe=0; scoreEn=0; sim=0;
  initMap();
  for(let i=0;i<28;i++) antsMe.push(spawnAnt('me'));
  for(let j=0;j<22;j++) antsEn.push(spawnAnt('en'));
  buildSel(); refreshMats(); refreshInv(); refreshNeeds();
  fit(); fitAll(); updateView(); zoomAll=true; // 開場全景（先設比例再首次繪圖）
  draw(); drawWind(); drawHum(); drawTime(); drawZoom();
  updateFoodUI();
}

reset(); requestAnimationFrame(loop);
})();</script>
</body>
</html>
