<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>紅血球循環 3D 模擬（ESM 離線版）</title>
<style>
  html,body{margin:0;height:100%;background:#0b0f14;overflow:hidden;touch-action:none}
  #app{position:fixed;inset:0}
  .hud{position:fixed;left:10px;top:10px;display:grid;gap:8px;z-index:10;font-family:sans-serif}
  .panel{background:rgba(12,16,22,.82);border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:10px 12px;color:#eee}
  .modes{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
  button{border:1px solid rgba(255,255,255,.15);background:rgba(24,28,35,.9);color:#fff;padding:8px 10px;border-radius:8px;cursor:pointer}
  button.active{background:rgba(140,18,28,.9)}
  .footer{position:fixed;right:10px;bottom:10px;font-size:12px;color:#ccc;background:rgba(12,16,22,.65);padding:6px 10px;border-radius:10px}
</style>
</head>
<body>
<div id="app"></div>
<div class="hud">
  <div class="panel">
    <div style="font-weight:600;margin-bottom:6px;">血流模式</div>
    <div class="modes">
      <button id="mode-sleep">睡眠</button>
      <button id="mode-rest" class="active">平時</button>
      <button id="mode-ex">運動</button>
    </div>
  </div>
</div>
<div class="footer">拖曳旋轉｜滾輪/雙指縮放｜右鍵平移</div>

<script type="module">
import * as THREE from './three.module.js';
import { OrbitControls } from './OrbitControls.js';

const app=document.getElementById('app');
const scene=new THREE.Scene(); scene.background=new THREE.Color(0x0b0f14);
const renderer=new THREE.WebGLRenderer({antialias:true}); renderer.setSize(innerWidth,innerHeight);
app.appendChild(renderer.domElement);

const camera=new THREE.PerspectiveCamera(55,innerWidth/innerHeight,0.1,2000);
camera.position.set(0,22,64);
const controls=new OrbitControls(camera,renderer.domElement);
controls.enableDamping=true; controls.dampingFactor=0.06;

const hemi=new THREE.HemisphereLight(0xffffff,0x101018,0.8);
scene.add(hemi);
const dir=new THREE.DirectionalLight(0xffffff,1);
dir.position.set(40,60,20); scene.add(dir);

const HEART=new THREE.Vector3(0,0,0),LUNG=new THREE.Vector3(38,6,0),BODY=new THREE.Vector3(-38,-4,0);
const shellMat=new THREE.MeshPhysicalMaterial({color:0xffec80,transparent:true,opacity:0.4,transmission:0.75,roughness:0.6,metalness:0});
const shells=[];
function addChamber(c,s,r=0){const g=new THREE.SphereGeometry(1,14,12),m=new THREE.Mesh(g,shellMat);
m.position.copy(c);m.scale.set(s.x,s.y,s.z);m.rotation.y=r;scene.add(m);shells.push(m);}
addChamber(new THREE.Vector3(-3,2,2),new THREE.Vector3(3.6,3.8,3.0),0.1);
addChamber(new THREE.Vector3(-1,-2,1),new THREE.Vector3(4.2,4.6,3.2),-0.1);
addChamber(new THREE.Vector3(3,2,-2),new THREE.Vector3(3.4,3.6,2.9),-0.08);
addChamber(new THREE.Vector3(3,-2,0),new THREE.Vector3(4.6,5.0,3.4),0.12);

function tube(points,r){const c=new THREE.CatmullRomCurve3(points,false,'centripetal',0.6);
const g=new THREE.TubeGeometry(c,64,r,16,false);const m=new THREE.MeshPhysicalMaterial({color:0xffec80,transparent:true,opacity:0.22});
const mesh=new THREE.Mesh(g,m);scene.add(mesh);}
tube([new THREE.Vector3(3,-2,0),new THREE.Vector3(-6,1,1),new THREE.Vector3(-14,8,2)],1.1);
tube([new THREE.Vector3(-1,-2,1),new THREE.Vector3(8,0,-1),new THREE.Vector3(20,2,-2)],1.0);
tube([new THREE.Vector3(30,6,-1),new THREE.Vector3(18,6,0),new THREE.Vector3(6,4,1)],0.9);
tube([new THREE.Vector3(-24,6,2),new THREE.Vector3(-12,4,2),new THREE.Vector3(-3,2,2)],1.0);

const heart=new THREE.Mesh(new THREE.SphereGeometry(3.2,18,18),new THREE.MeshStandardMaterial({color:0xa2121f,emissive:0x2a0000}));
heart.position.copy(HEART);scene.add(heart);

const path=new THREE.CatmullRomCurve3([
  new THREE.Vector3(-3,2,2),new THREE.Vector3(-1,-2,1),new THREE.Vector3(20,2,-2),LUNG.clone(),
  new THREE.Vector3(6,4,1),new THREE.Vector3(3,2,-2),new THREE.Vector3(3,-2,0),
  new THREE.Vector3(-14,8,2),BODY.clone(),new THREE.Vector3(-3,2,2)
],true,'centripetal',0.65);

const MAX=2600;
const geo=new THREE.SphereGeometry(0.36,10,10);
const mat=new THREE.MeshStandardMaterial({vertexColors:true});
const mesh=new THREE.InstancedMesh(geo,mat,MAX);
mesh.instanceMatrix.setUsage(THREE.DynamicDrawUsage);
mesh.instanceColor=new THREE.InstancedBufferAttribute(new Float32Array(MAX*3),3);
scene.add(mesh);
const red=new THREE.Color('#e03a3a'),blue=new THREE.Color('#2e6ae6');
const tmpMat=new THREE.Matrix4(),tmpPos=new THREE.Vector3(),tmpA=new THREE.Vector3();
const parts=[];for(let i=0;i<MAX;i++){parts.push({t:Math.random(),v:0.05+Math.random()*0.05,oxy:false});}

const MODE={SLEEP:{hr:52,speed:0.6},REST:{hr:70,speed:1.0},EX:{hr:140,speed:1.9}};
let target=MODE.REST,display={hr:70,speed:1.0};
function setMode(m){target=m;document.querySelectorAll('button').forEach(b=>b.classList.remove('active'));
if(m===MODE.SLEEP)modeSleep.classList.add('active');
if(m===MODE.REST)modeRest.classList.add('active');
if(m===MODE.EX)modeEx.classList.add('active');}
modeSleep.onclick=()=>setMode(MODE.SLEEP);
modeRest.onclick=()=>setMode(MODE.REST);
modeEx.onclick=()=>setMode(MODE.EX);

function place(i,t){path.getPointAt(t%1,tmpPos);tmpMat.setPosition(tmpPos);mesh.setMatrixAt(i,tmpMat);}
function setColor(i,c){mesh.setColorAt(i,c);}
for(let i=0;i<MAX;i++){place(i,parts[i].t);setColor(i,blue);}
mesh.instanceMatrix.needsUpdate=true;mesh.instanceColor.needsUpdate=true;

const uL=0.25,uB=0.75;
function isOxy(t){return t>=uL && t<uB;}
let last=performance.now();
function animate(now){requestAnimationFrame(animate);
const dt=(now-last)/1000;last=now;
display.hr+= (target.hr-display.hr)*dt*2;
display.speed+= (target.speed-display.speed)*dt*2;
const pulse=(now*0.001)*(display.hr/60)*Math.PI*2;
heart.scale.setScalar(1+Math.max(0,Math.sin(pulse))*0.06);
let r=0;for(let i=0;i<MAX;i++){const p=parts[i];p.t+=p.v*display.speed*dt*0.05;if(p.t>1)p.t-=1;
p.oxy=isOxy(p.t);r+=p.oxy?1:0;place(i,p.t);setColor(i,p.oxy?red:blue);}
mesh.instanceMatrix.needsUpdate=true;mesh.instanceColor.needsUpdate=true;
controls.update();renderer.render(scene,camera);}
animate();
addEventListener('resize',()=>{camera.aspect=innerWidth/innerHeight;camera.updateProjectionMatrix();renderer.setSize(innerWidth,innerHeight);});
</script>
</body>
</html>
