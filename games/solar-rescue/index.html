<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>ç´…å·¨æ˜Ÿæ•‘æ´è¨ˆç•«ï¼šSolar Rescue (v8 Orbit Assist + README)</title>
<style>
  html, body { margin:0; height:100%; background:#000; color:#fff;
    font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans TC","Helvetica Neue",Arial;
    -webkit-user-select:none; user-select:none; overscroll-behavior:none }
  #ui{position:fixed;left:0;right:0;top:0;display:flex;gap:10px;padding:8px 12px;align-items:center;
      background:linear-gradient(180deg,rgba(0,0,0,.7),rgba(0,0,0,.25));backdrop-filter:blur(2px);z-index:3;font-size:14px}
  .pill{padding:4px 8px;border-radius:999px;background:rgba(255,255,255,.08)}
  #buttons{margin-left:auto;display:flex;gap:8px;align-items:center}
  button{background:rgba(255,255,255,.12);color:#fff;border:0;border-radius:8px;padding:6px 10px;font-size:14px}
  button:hover{background:rgba(255,255,255,.18);cursor:pointer}
  #msg{position:fixed;left:50%;top:60px;transform:translateX(-50%);padding:8px 12px;border-radius:8px;background:rgba(0,0,0,.6);
       z-index:3;pointer-events:none;opacity:0;transition:opacity .2s ease;white-space:pre-line}
  #sunbar{position:fixed;left:0;right:0;bottom:0;height:8px;z-index:2;background:rgba(255,255,255,.08)}
  #sunfill{height:100%;width:0;background:linear-gradient(90deg,#ffcf33,#ff3b3b)}
  canvas{display:block;width:100vw;height:100vh;touch-action:none}
  #hint{position:fixed;right:12px;bottom:16px;z-index:3;background:rgba(0,0,0,.45);padding:6px 10px;border-radius:8px;font-size:12px;opacity:.9}
  /* Modal */
  #modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:5;background:rgba(0,0,0,.55)}
  #modal .card{width:min(720px,90vw);max-height:80vh;overflow:auto;background:#101114;border:1px solid rgba(255,255,255,.1);border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.4)}
  #modal header{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid rgba(255,255,255,.08)}
  #modal header h3{margin:0;font-size:16px}
  #modal .body{padding:16px}
  #modal .body pre{white-space:pre-wrap;word-wrap:break-word;font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
</style>
</head>
<body>
<div id="ui">
  <div class="pill">é—œå¡ï¼š<span id="levelName">â€”</span></div>
  <div class="pill">å‰©é¤˜ç”Ÿç‰©ï¼š<span id="leftCount">â€”</span></div>
  <div class="pill">å·²æ•‘æ´ ğŸ§ï¼š<span id="rescued">0</span></div>
  <div class="pill">æ­»äº¡ ğŸ’€ï¼š<span id="dead">0</span></div>
  <div class="pill">æ˜Ÿè‰¦èƒ½æº ğŸ”‹ï¼š<span id="energy">50</span></div>
  <div class="pill"><label><input id="vecToggle" type="checkbox"> é¡¯ç¤ºå‘é‡</label></div>
  <div id="buttons">
    <button id="readmeBtn">éŠæˆ²èªªæ˜ ğŸ“–</button>
    <button id="retryBtn">é‡ç©é—œå¡</button>
    <button id="nextBtn" disabled>ä¸‹ä¸€é—œ â–¶</button>
  </div>
</div>
<div id="msg"></div>
<div id="sunbar"><div id="sunfill"></div></div>
<canvas id="game"></canvas>
<div id="hint">æ‹‰å¼“å¼ç™¼å°„ï¼šæŒ‰ä¸‹=ç™¼å°„é» â†’ å¾€å¾Œæ‹‰=é€Ÿåº¦ï¼ˆæ–¹å‘å–åï¼‰â†’ æ”¾é–‹=ç™¼å°„ï¼›å¤šé‡ç™¼å°„ï¼›æ¯æ¬¡-2èƒ½æºï¼Œæ•‘æ´+10ï¼›èƒ½æº=0çµæŸ</div>

<!-- Modal -->
<div id="modal">
  <div class="card">
    <header>
      <h3>README</h3>
      <button id="closeModal">é—œé–‰</button>
    </header>
    <div class="body"><pre id="mdContent">è¼‰å…¥ä¸­...</pre></div>
  </div>
</div>

<script>
/* ====== Canvas & DPIï¼šç¶­æŒåœ“å½¢ ====== */
const canvas=document.getElementById('game'); const ctx=canvas.getContext('2d',{alpha:false});
function resizeCanvas(){ const dpr=Math.max(1,window.devicePixelRatio||1); const vw=Math.max(document.documentElement.clientWidth,innerWidth||0); const vh=Math.max(document.documentElement.clientHeight,innerHeight||0); canvas.width=Math.round(vw*dpr); canvas.height=Math.round(vh*dpr); ctx.setTransform(1,0,0,1,0,0); ctx.scale(dpr,dpr) }
addEventListener('resize',resizeCanvas); if(window.visualViewport) window.visualViewport.addEventListener('resize',resizeCanvas); addEventListener('orientationchange',()=>setTimeout(resizeCanvas,200)); resizeCanvas();

/* ====== éŠæˆ²è³‡æ–™ ====== */
const PLANETS=[
{name:"æ°´æ˜Ÿ",g:3.7,r:90,color:"#7a8aa0",creatures:5},
{name:"é‡‘æ˜Ÿ",g:8.87,r:120,color:"#d8b45b",creatures:6},
{name:"åœ°çƒ",g:9.81,r:130,color:"#5fb9e5",creatures:7},
{name:"ç«æ˜Ÿ",g:3.71,r:110,color:"#b3533a",creatures:7},
{name:"æœ¨æ˜Ÿ",g:24.79,r:180,color:"#d89a6a",creatures:10},
{name:"åœŸæ˜Ÿ",g:10.44,r:165,color:"#cdbb89",creatures:9,ring:true},
{name:"å¤©ç‹æ˜Ÿ",g:8.69,r:140,color:"#7fd0c4",creatures:8},
{name:"æµ·ç‹æ˜Ÿ",g:11.15,r:145,color:"#355edb",creatures:8}
];
const G_CONST=13500; // from v7
const EARTH_R=130;

/* UI */
const ui={lvl:document.getElementById('levelName'),left:document.getElementById('leftCount'),res:document.getElementById('rescued'),dead:document.getElementById('dead'),energy:document.getElementById('energy'),next:document.getElementById('nextBtn'),retry:document.getElementById('retryBtn'),sun:document.getElementById('sunfill'),msg:document.getElementById('msg'),vec:document.getElementById('vecToggle'),readme:document.getElementById('readmeBtn')};
function showMsg(t,ms=1200){ui.msg.textContent=t;ui.msg.style.opacity=1;clearTimeout(showMsg._t);showMsg._t=setTimeout(()=>ui.msg.style.opacity=0,ms)}

/* ç‹€æ…‹ */
let level=0,rescuedTotal=0,deadTotal=0,planet=null,creatures=[],ships=[],sunProgress=0;
let dragging=false,anchor=null,pointer=null,activePointerId=null,creatureRing=100,energy=50,ended=false;

/* å¹¾ä½• */
function planetCenter(){ const dpr=window.devicePixelRatio||1; return {x:canvas.width/dpr*0.5,y:canvas.height/dpr*0.55} }

/* ç”Ÿç‰©ï¼šåœ“å‘¨ä¸Šé‹å‹• */
function spawnCreatures(n){creatures=[];for(let i=0;i<n;i++){const ang=Math.random()*Math.PI*2;const speed=(Math.random()<0.5?-1:1)*(0.35+Math.random()*0.55);creatures.push({alive:true,angle:ang,speed})}}

/* é£›èˆ¹ï¼šæ‹‰å¼“ç™¼å°„ */
function addShip(pos,release){
  if(ended) return;
  if(energy<2){showMsg('âš ï¸ æ˜Ÿè‰¦èƒ½æºä¸è¶³ï¼ˆéœ€è¦ 2 é»ï¼‰'); return}
  const dx=release.x-pos.x, dy=release.y-pos.y;
  const s=0.35; // åˆé€Ÿï¼ˆæ‹‰å¼“åå‘ï¼‰
  let vx=-dx*s, vy=-dy*s;
  energy-=2; ui.energy.textContent=energy;
  ships.push({x:pos.x,y:pos.y,vx,vy,alive:true,carrying:false,t:0,trail:[],_orbitStable:false,_orbitTimer:0});
  if(energy<=0){ endGame('ğŸ”‹ èƒ½æºè€—ç›¡ï¼Œä»»å‹™å¤±æ•—'); }
}

/* é—œå¡æµç¨‹ */
function loadLevel(i){
  level=i; planet=structuredClone(PLANETS[i]);
  planet.drag=(planet.name==='é‡‘æ˜Ÿ')?0.0006:0.00015; if(['å¤©ç‹æ˜Ÿ','æµ·ç‹æ˜Ÿ'].includes(planet.name)) planet.drag*=.6;
  planet.drag*=0.4; // v8: å†é™ä½é˜»åŠ› â†’ æå‡ç¹è¡Œæ©Ÿç‡
  ui.lvl.textContent=`${i+1}/8 ${planet.name}`;
  creatureRing=planet.r*1.05; spawnCreatures(planet.creatures); ui.left.textContent=creatures.length;
  ui.next.disabled=true; ships=[]; sunProgress=i/PLANETS.length; ui.sun.style.width=`${Math.floor(100*sunProgress)}%`;
  showMsg(`ç¬¬ ${i+1} é—œï¼š${planet.name}`); loadLevel._rescuedAtStart=rescuedTotal; ended=false;
}
function winLevel(){ if(ended) return; ui.next.disabled=false; showMsg('âœ… æœ¬é—œå®Œæˆï¼') }
function gameOver(){ endGame('âŒ ç”Ÿç‰©å…¨æ»…ï¼Œä»»å‹™å¤±æ•—') }
function endGame(text){ ended=true; showMsg(text,1800); }

/* äº‹ä»¶åº§æ¨™ */
function getPoint(e){return e.touches&&e.touches.length?{x:e.touches[0].clientX,y:e.touches[0].clientY}:{x:e.clientX,y:e.clientY}}

/* æ‰‹å‹¢ï¼ˆæ‹‰å¼“å¼ï¼‰ */
canvas.addEventListener('pointerdown',e=>{ if(ended) return; e.preventDefault(); activePointerId=e.pointerId; canvas.setPointerCapture(activePointerId); dragging=true; anchor=getPoint(e); pointer=anchor });
canvas.addEventListener('pointermove',e=>{ if(!dragging||e.pointerId!==activePointerId) return; e.preventDefault(); pointer=getPoint(e) });
function endGesture(e){ if(!dragging||e.pointerId!==activePointerId) return; e.preventDefault(); const release=getPoint(e); addShip(anchor,release); dragging=false; activePointerId=null }
canvas.addEventListener('pointerup',endGesture); canvas.addEventListener('pointercancel',endGesture);

/* =========== ç‰©ç†ï¼ˆå­æ­¥é€² + orbit assistï¼‰ =========== */
function physicsSubstep(dt){
  const c=planetCenter();
  // ç”Ÿç‰©
  for(const b of creatures){ if(b.alive) b.angle+=b.speed*dt }
  // é£›èˆ¹
  for(const ship of ships){
    if(!ship.alive) continue;
    ship.t+=dt;
    const rx=c.x-ship.x, ry=c.y-ship.y, r2=rx*rx+ry*ry, r=Math.sqrt(r2);
    // æ’æ˜Ÿçƒ
    if(r<planet.r*.95){
      const v=Math.hypot(ship.vx,ship.vy);
      let kill=Math.min(creatures.filter(b=>b.alive).length, Math.max(1,Math.floor(v/140)+(planet.g>10?1:0)));
      for(const b of creatures){ if(kill>0 && b.alive){ b.alive=false; kill--; } }
      deadTotal+=Math.max(1,Math.floor(v/140)+(planet.g>10?1:0)); ui.dead.textContent=deadTotal; ui.left.textContent=creatures.filter(b=>b.alive).length;
      showMsg('ğŸ’¥ å¢œæ¯€ï¼'); ship.alive=false; checkState(); continue;
    }
    // é‡åŠ›: a = mu / (r^2 + soft^2) * rÌ‚ï¼Œmu = G_CONST * g * (EARTH_R/planet.r)
    const soft = (planet.r*0.25)**2; // è»ŸåŒ–æ ¸å¿ƒï¼Œé¿å…è¿‘åœ°çˆ†åŠ›
    const mu = G_CONST * planet.g * (EARTH_R/planet.r);
    const grav = mu / Math.max(r2 + soft, 800);
    const ax = grav * (rx / (r||1)), ay = grav * (ry / (r||1));
    // é˜»åŠ›
    ship.vx += (ax - ship.vx*planet.drag) * dt;
    ship.vy += (ay - ship.vy*planet.drag) * dt;
    ship.x  += ship.vx * dt; ship.y += ship.vy * dt;

    // === Orbit Assistï¼ˆæé«˜ç©©å®šç¹è¡Œæ©Ÿç‡ï¼‰ ===
    // 1) è¿‘è¡Œæ˜Ÿç’°å¸¶æ™‚ï¼Œå°‡é€Ÿåº¦å¾®é‡ã€Œåˆ‡ç·šåŒ–ã€
    const nearR = r > planet.r*1.02 && r < planet.r*1.9;
    if(nearR){
      const sign = (ship.vx*ry - ship.vy*rx) >= 0 ? 1 : -1; // è§’å‹•é‡æ–¹å‘
      const invr = 1/(r||1);
      const tx = -sign*ry*invr; // åˆ‡ç·šå–®ä½å‘é‡
      const ty =  sign*rx*invr;
      // ç›®æ¨™åœ“è»Œé€Ÿåº¦ï¼šv_circ = sqrt(mu / r)
      const vCirc = Math.sqrt(mu / Math.max(r, 1));
      const blend = 0.55 * dt; // å¾®é‡ä¿®æ­£ä¿‚æ•¸ï¼ˆå¯èª¿ï¼‰
      const targetVx = tx * vCirc;
      const targetVy = ty * vCirc;
      ship.vx = ship.vx*(1-blend) + targetVx*blend;
      ship.vy = ship.vy*(1-blend) + targetVy*blend;
    }

    // èˆªè·¡ï¼ˆæ·¡åŒ– lifeï¼‰
    ship.trail.push({x:ship.x,y:ship.y, life:1});
    for(let i=0;i<ship.trail.length;i++){ ship.trail[i].life -= dt*0.9 }
    ship.trail = ship.trail.filter(p=>p.life>0);
    if (ship.trail.length>260) ship.trail.shift();

    // ç¹è¡Œåˆ¤å®šï¼ˆæ›´å¯¬é¬†ï¼‰
    const vmag=Math.hypot(ship.vx,ship.vy);
    const dot=(ship.vx*rx+ship.vy*ry)/(vmag*r+1e-6);
    const nearT=Math.abs(dot)<.28, nearBand=r>planet.r*1.02 && r<planet.r*1.85;
    if(nearT&&nearBand){ ship._orbitTimer=(ship._orbitTimer||0)+dt; if(ship._orbitTimer>0.5) ship._orbitStable=true }
    else { ship._orbitTimer=Math.max(0,(ship._orbitTimer||0)-dt*.7); if(ship._orbitTimer<.18) ship._orbitStable=false }

    // æ•‘æ´
    if(ship._orbitStable && !ship.carrying){
      const cap=18;
      for(const b of creatures){
        if(!b.alive) continue;
        const bx=c.x+Math.cos(b.angle)*creatureRing, by=c.y+Math.sin(b.angle)*creatureRing;
        if(Math.hypot(ship.x-bx,ship.y-by)<cap){
          b.alive=false; ship.carrying=true; rescuedTotal++; ui.res.textContent=rescuedTotal; ui.left.textContent=creatures.filter(x=>x.alive).length;
          energy+=10; ui.energy.textContent=energy; showMsg('ğŸ§ æ•‘æ´æˆåŠŸï¼+10 èƒ½æº'); break;
        }
      }
    }
    // å¸¶ç”Ÿç‰©é€ƒé›¢
    if(ship.carrying){
      const nx=(ship.x-c.x)/(r||1), ny=(ship.y-c.y)/(r||1);
      ship.vx+=nx*8*planet.drag; ship.vy+=ny*8*planet.drag;
      const W=canvas.width/(window.devicePixelRatio||1), H=canvas.height/(window.devicePixelRatio||1);
      if(ship.x<-80||ship.x>W+80||ship.y<-80||ship.y>H+80){ ship.alive=false; checkState(); }
    }else{
      const W=canvas.width/(window.devicePixelRatio||1), H=canvas.height/(window.devicePixelRatio||1);
      if(ship.x<-240||ship.x>W+240||ship.y<-240||ship.y>H+240){ ship.alive=false; }
    }
  }
}
function step(dt){
  if(ended) return;
  const n=5, h=dt/n; for(let i=0;i<n;i++) physicsSubstep(h);
  ships=ships.filter(s=>s.alive);
}
function checkState(){
  const alive=creatures.filter(b=>b.alive).length;
  if(alive===0){ if(rescuedTotal-(loadLevel._rescuedAtStart??0)>0){ winLevel() } else { gameOver() } }
}

/* è‰²å½©å·¥å…· */
function hexRgb(hex){ const n=parseInt(hex.replace('#',''),16); return {r:(n>>16)&255,g:(n>>8)&255,b:n&255} }
function lighten(hex,k){ const {r,g,b}=hexRgb(hex); const L=c=>Math.min(255,Math.round(c+(255-c)*k)); return `rgb(${L(r)},${L(g)},${L(b)})` }
function shade(hex,k){ const {r,g,b}=hexRgb(hex); const S=c=>Math.max(0,Math.round(c*(1-k))); return `rgb(${S(r)},${S(g)},${S(b)})` }

/* ç¹ªè£½ */
function draw(){
  const dpr=window.devicePixelRatio||1, W=canvas.width/dpr, H=canvas.height/dpr, c=planetCenter();
  // èƒŒæ™¯
  const grd=ctx.createRadialGradient(W*.15,H*.2,30,W*.15,H*.2,Math.max(W,H)*.9);
  grd.addColorStop(0,`rgba(${200+Math.floor(55*(level/8))},${150-Math.floor(90*(level/8))},40,.5)`);
  grd.addColorStop(1,'#000'); ctx.fillStyle=grd; ctx.fillRect(0,0,W,H);
  if(!planet) return;
  // è¡Œæ˜Ÿï¼ˆæ­£åœ“ï¼‰
  const pgr=ctx.createRadialGradient(c.x-planet.r*.4,c.y-planet.r*.4,planet.r*.2,c.x,c.y,planet.r*1.2);
  pgr.addColorStop(0,lighten(planet.color,.25)); pgr.addColorStop(.7,planet.color); pgr.addColorStop(1,shade(planet.color,.65));
  ctx.fillStyle=pgr; ctx.beginPath(); ctx.arc(c.x,c.y,planet.r,0,Math.PI*2); ctx.fill();
  if(planet.ring){ ctx.save(); ctx.translate(c.x,c.y); ctx.rotate(-.35);
    ctx.strokeStyle="rgba(230,210,160,.65)"; ctx.lineWidth=12; ctx.beginPath(); ctx.ellipse(0,0,planet.r*1.55,planet.r*.75,0,0,Math.PI*2); ctx.stroke();
    ctx.lineWidth=4; ctx.strokeStyle="rgba(230,210,160,.3)"; ctx.beginPath(); ctx.ellipse(0,0,planet.r*1.35,planet.r*.66,0,0,Math.PI*2); ctx.stroke(); ctx.restore(); }
  // ç”Ÿç‰©ï¼ˆåœ“å‘¨å‰ªå½±ï¼‰
  for(const b of creatures){ if(!b.alive) continue;
    const bx=c.x+Math.cos(b.angle)*creatureRing, by=c.y+Math.sin(b.angle)*creatureRing; drawCreature(bx,by,10) }
  // èˆªè·¡ï¼ˆæ·¡åŒ–ï¼‰
  for(const ship of ships){
    if(!ship.alive || ship.trail.length<2) continue;
    const n=ship.trail.length;
    for(let i=1;i<n;i++){
      const p0=ship.trail[i-1], p1=ship.trail[i];
      const alpha=Math.max(0, Math.min(1, p1.life));
      ctx.strokeStyle = ship._orbitStable ? `rgba(100,255,180,${alpha})` : `rgba(255,255,255,${alpha*.9})`;
      ctx.lineWidth = 2;
      ctx.beginPath(); ctx.moveTo(p0.x,p0.y); ctx.lineTo(p1.x,p1.y); ctx.stroke();
    }
  }
  // é£›èˆ¹ + å‘é‡ç®­é ­
  for(const ship of ships){
    if(!ship.alive) continue;
    drawShip(ship.x,ship.y,ship.vx,ship.vy,ship.carrying);
    if(document.getElementById('vecToggle').checked){
      const vlen=Math.hypot(ship.vx,ship.vy);
      if(vlen>0.001){ ctx.strokeStyle="rgba(255,255,255,.9)"; ctx.beginPath(); ctx.moveTo(ship.x,ship.y); ctx.lineTo(ship.x+ship.vx*0.12, ship.y+ship.vy*0.12); ctx.stroke(); }
      const gx=c.x-ship.x, gy=c.y-ship.y, gl=Math.hypot(gx,gy)||1;
      ctx.strokeStyle="rgba(255,90,90,.95)"; ctx.beginPath(); ctx.moveTo(ship.x,ship.y); ctx.lineTo(ship.x+gx/gl*28, ship.y+gy/gl*28); ctx.stroke();
    }
  }
  // æ‹–æ›³é è¦½ï¼ˆè™›ç·šã€åå‘ç®­é ­ï¼‰
  if(dragging && anchor && pointer){
    ctx.save(); ctx.setLineDash([8,6]); ctx.strokeStyle="rgba(255,255,255,.9)"; ctx.lineWidth=2;
    ctx.beginPath(); ctx.moveTo(anchor.x,anchor.y); ctx.lineTo(pointer.x,pointer.y); ctx.stroke();
    ctx.setLineDash([]);
    const dx=pointer.x-anchor.x, dy=pointer.y-anchor.y;
    const ax=anchor.x - dx*0.18, ay=anchor.y - dy*0.18;
    ctx.beginPath(); ctx.moveTo(ax,ay); ctx.lineTo(ax - dx*0.12, ay - dy*0.12); ctx.strokeStyle="rgba(160,220,255,.9)"; ctx.stroke();
    ctx.fillStyle="rgba(255,255,255,.15)"; ctx.beginPath(); ctx.arc(anchor.x,anchor.y,6,0,Math.PI*2); ctx.fill(); ctx.restore();
  }
  // è¼”åŠ©ï¼šå»ºè­°è»Œé“å¸¶
  ctx.strokeStyle="rgba(255,255,255,.08)"; ctx.lineWidth=1; ctx.beginPath(); ctx.arc(c.x,c.y,planet.r*1.2,0,Math.PI*2); ctx.stroke();
}

function drawCreature(x,y,s){ ctx.save(); ctx.translate(x,y); ctx.fillStyle="#000"; ctx.shadowColor="rgba(0,0,0,.25)"; ctx.shadowBlur=6;
  ctx.beginPath(); ctx.moveTo(0,-s*.9); ctx.quadraticCurveTo(s*.9,-s*.1,0,s); ctx.quadraticCurveTo(-s*.9,-s*.1,0,-s*.9); ctx.fill();
  ctx.strokeStyle="#000"; ctx.lineWidth=2; ctx.beginPath(); ctx.moveTo(-s*.2,-s*.7); ctx.quadraticCurveTo(-s*.6,-s*1.1,-s*.4,-s*1.2);
  ctx.moveTo(s*.2,-s*.7); ctx.quadraticCurveTo(s*.6,-s*1.1,s*.4,-s*1.2); ctx.stroke(); ctx.restore(); }
function drawShip(x,y,vx,vy,carrying){ const ang=Math.atan2(vy,vx); ctx.save(); ctx.translate(x,y); ctx.rotate(ang);
  ctx.fillStyle=carrying?"#7bffc9":"#fff"; ctx.beginPath(); ctx.moveTo(14,0); ctx.lineTo(-10,-6); ctx.lineTo(-6,0); ctx.lineTo(-10,6); ctx.closePath(); ctx.fill();
  ctx.fillStyle=carrying?"rgba(100,255,200,.8)":"rgba(255,160,80,.9)"; ctx.beginPath(); ctx.moveTo(-10,0); ctx.lineTo(-18,-3); ctx.lineTo(-16,0); ctx.lineTo(-18,3); ctx.closePath(); ctx.fill(); ctx.restore(); }

/* ä¸»è¿´åœˆ */
let last=performance.now();
function loop(now){ const dt=Math.min(.033,(now-last)/1000); last=now; step(dt); draw(); requestAnimationFrame(loop) }

/* æ§åˆ¶æŒ‰éˆ• */
ui.retry.onclick=()=>{ energy=50; ui.energy.textContent=energy; loadLevel(level); loadLevel._rescuedAtStart=rescuedTotal };
ui.next.onclick=()=>{ if(level<PLANETS.length-1){ loadLevel(level+1); loadLevel._rescuedAtStart=rescuedTotal } else { showMsg('ğŸ‰ å…¨éƒ¨é—œå¡å®Œæˆï¼') } };

/* README modal */
const modal = document.getElementById('modal');
document.getElementById('readmeBtn').onclick = async ()=>{
  modal.style.display='flex';
  const pre = document.getElementById('mdContent');
  pre.textContent = 'è¼‰å…¥ä¸­...';
  try{
    const res = await fetch('readme.md', {cache:'no-store'});
    if(!res.ok) throw new Error(res.status+' '+res.statusText);
    pre.textContent = await res.text();
  }catch(err){
    pre.textContent = 'è®€å– readme.md å¤±æ•—ï¼š'+err;
  }
};
document.getElementById('closeModal').onclick = ()=>{ modal.style.display='none' };

/* å•Ÿå‹• */
loadLevel(0); requestAnimationFrame(loop);
</script>
</body>
</html>